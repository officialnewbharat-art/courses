<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Excel Mastery | Internadda</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #4338ca; 
            --primary-hover: #3730a3;
            --secondary: #10b981;
            --accent: #8b5cf6;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --text-main: #1e293b;
            --text-light: #64748b;
            --white: #ffffff;
            --off-white: #f8fafc;
            --border: #e2e8f0;
            --border-dark: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --header-height: 75px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
            --gradient-primary: linear-gradient(135deg, #4338ca 0%, #7c3aed 100%);
            --gradient-dark: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--off-white); color: var(--text-main); line-height: 1.8; overflow-x: hidden; }

        /* --- HEADER & PROGRESS --- */
        header { 
            background: var(--white); 
            border-bottom: 1px solid var(--border); 
            box-shadow: var(--shadow-sm);
            position: fixed; top: 0; width: 100%; z-index: 1000; height: var(--header-height);
            display: flex; align-items: center; padding: 0 25px;
        }
        .nav-container { 
            display: flex; align-items: center; justify-content: space-between; 
            width: 100%; max-width: 1400px; margin: 0 auto; 
        }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo-icon { color: var(--primary); font-size: 1.8rem; }
        .logo-text { font-weight: 800; font-size: 1.5rem; color: #0f172a; text-decoration: none; letter-spacing: -0.5px; }
        .logo-text span { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .progress-stats { display: flex; align-items: center; gap: 15px; }
        .progress-percent { font-weight: 800; font-size: 1rem; color: var(--primary); background: #eef2ff; padding: 6px 12px; border-radius: 20px; }
        @media (max-width: 768px) {
            .nav-container { 
                display: flex; 
                justify-content: center; /* Centers the logo container */
                align-items: center;
                position: relative; 
            }
            .sidebar-toggle { 
                display: block !important; 
                position: absolute; /* Takes toggle out of flow so logo can center */
                left: 0; 
                z-index: 1001; 
            }
            .logo-text { font-size: 1.3rem; }
            .progress-stats { display: none !important; } /* Hide % in header */
        }
        /* --- SIDEBAR & OVERLAY --- */
        .sidebar {
            position: fixed; top: 0; left: -350px; width: 320px; height: 100vh;
            background: var(--dark-bg); z-index: 1100; padding: 30px 0;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); color: white; overflow-y: auto;
            box-shadow: 5px 0 30px rgba(0,0,0,0.2);
        }
        .sidebar.active { left: 0; }
        .sidebar-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1050; display: none; 
            backdrop-filter: blur(3px); 
        }
        .sidebar-overlay.active { display: block; }
        .sidebar-header { padding: 0 25px 25px; border-bottom: 1px solid var(--border-dark); margin-bottom: 20px; }
        .sidebar-title { font-size: 1.1rem; font-weight: 700; color: #cbd5e1; letter-spacing: 0.5px; }
        .module-item { 
            padding: 16px 25px; margin: 0 15px 8px; border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; gap: 15px; transition: all 0.3s; 
            background: rgba(255,255,255,0.03); border: 1px solid transparent; 
        }
        .module-item:hover { background: rgba(255,255,255,0.07); }
        .module-item.active { 
            background: rgba(67, 56, 202, 0.15); border-color: var(--primary); 
            box-shadow: 0 4px 12px rgba(67, 56, 202, 0.15); 
        }
        .module-number { 
            width: 28px; height: 28px; background: rgba(255,255,255,0.1); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 0.85rem; font-weight: 700; 
        }
        .module-item.active .module-number { background: var(--primary); }
        .module-text { flex: 1; }
        .module-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 3px; }
        .module-desc { font-size: 0.8rem; color: #94a3b8; }
        .module-status { font-size: 0.9rem; }
        .module-item.locked { opacity: 0.6; cursor: not-allowed; }

        /* --- CONTENT UI --- */
        .main-layout { 
            margin-top: calc(var(--header-height) + 30px); padding: 0 20px 80px; 
            display: flex; justify-content: center; 
        }
        .content-card { 
            background: white; border-radius: 28px; padding: 50px; max-width: 920px; width: 100%; 
            border: 1px solid var(--border); box-shadow: var(--shadow-md); 
            position: relative; overflow: hidden; 
        }
        .content-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: var(--gradient-primary);
        }
        
        @keyframes reveal { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .animate-content { animation: reveal 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards; }

        .module-tag { 
            display: inline-flex; align-items: center; gap: 6px;
            background: #eef2ff; color: var(--primary); padding: 6px 14px; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 800; 
            text-transform: uppercase; margin-bottom: 20px; letter-spacing: 0.5px; 
        }
        .mod-title { 
            font-size: 2.4rem; font-weight: 800; color: var(--dark-bg); 
            margin-bottom: 25px; letter-spacing: -1px; line-height: 1.2; 
        }
        .body-text { 
            margin-bottom: 25px; font-size: 1.1rem; color: #334155; 
            line-height: 1.7; 
        }
        
        pre { 
            background: #0f172a; color: #e2e8f0; padding: 25px; border-radius: 16px; 
            margin: 25px 0; overflow-x: auto; font-family: 'Fira Code', monospace; 
            font-size: 0.9rem; border: 1px solid #1e293b; box-shadow: inset 0 2px 10px rgba(0,0,0,0.2); 
            position: relative; 
        }
        pre::before {
            content: 'Excel Formula'; position: absolute; top: 0; right: 20px;
            background: var(--primary); color: white; padding: 4px 12px;
            font-size: 0.7rem; border-radius: 0 0 6px 6px; font-weight: 700;
        }

        .section-head { 
            font-size: 1.6rem; font-weight: 700; color: var(--dark-bg); 
            margin: 35px 0 15px; padding-bottom: 10px; border-bottom: 2px solid #eef2ff; 
        }
        .subsection-head { 
            font-size: 1.2rem; font-weight: 600; color: var(--dark-bg); 
            margin: 25px 0 12px; 
        }
        .pro-note {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9; padding: 20px; border-radius: 12px;
            margin: 25px 0; font-size: 0.95rem;
        }
        .pro-note b { color: #0369a1; }

        /* --- BUTTONS --- */
        .btn-primary, .btn-premium { 
            background: var(--gradient-primary); color: white; padding: 18px 35px; 
            border-radius: 14px; border: none; font-weight: 700; cursor: pointer; 
            transition: all 0.3s ease; width: 100%; display: flex; align-items: center; 
            justify-content: center; gap: 12px; font-size: 1rem; letter-spacing: 0.3px;
            box-shadow: 0 6px 20px rgba(67, 56, 202, 0.25); margin-top: 30px;
        }
        .btn-primary:hover, .btn-premium:hover { 
            transform: translateY(-3px); box-shadow: 0 12px 25px rgba(67, 56, 202, 0.35); 
        }

        /* Landing Page Enhancements */
        .hero-section { 
            text-align: center; padding: 140px 20px 80px; max-width: 1000px; margin: 0 auto; 
        }
        .hero-title { 
            font-size: 3.8rem; font-weight: 800; margin-bottom: 25px; letter-spacing: -2px; 
            line-height: 1.1; opacity: 0; animation: reveal 0.8s 0.2s forwards; 
        }
        
        .instructor-card { 
            background: #fff; border: 1px solid var(--border); border-radius: 24px; 
            padding: 30px; display: flex; align-items: center; gap: 25px; 
            max-width: 550px; margin: 40px auto; text-align: left;
            box-shadow: var(--shadow-md); opacity: 0; animation: reveal 0.8s 0.6s forwards;
        }
        .instructor-img { 
            width: 80px; height: 80px; border-radius: 50%; background: #ddd; 
            object-fit: cover; border: 4px solid #eef2ff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .badge-verified { 
            color: var(--success); font-size: 0.8rem; font-weight: 700; 
            background: #f0f9ff; padding: 4px 12px; border-radius: 20px; 
            display: inline-flex; align-items: center; gap: 5px; margin-bottom: 8px; 
        }

        .perks-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 20px; max-width: 900px; margin: 50px auto; 
            opacity: 0; animation: reveal 0.8s 0.4s forwards;
        }
        .perk-item { 
            background: white; padding: 25px 20px; border-radius: 18px; 
            border: 1px solid var(--border); font-size: 0.9rem; font-weight: 700; 
            text-align: center; box-shadow: var(--shadow-sm); transition: transform 0.3s;
        }
        .perk-item:hover { transform: translateY(-5px); }
        .perk-item i { 
            color: var(--primary); margin-bottom: 12px; display: block; 
            font-size: 1.8rem; 
        }

        /* Quiz Styles */
        .quiz-box, .cert-input-box { 
            margin-top: 40px; animation: reveal 0.5s ease; 
        }
        .q-block { margin-bottom: 30px; }
        .option-label { 
            display: flex; align-items: center; background: white; padding: 20px; 
            margin-bottom: 15px; border: 2px solid var(--border); border-radius: 16px; 
            cursor: pointer; transition: all 0.2s; position: relative; 
        }
        .option-label:hover { border-color: #c7d2fe; background: #f8fafc; }
        .option-input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; left:0; top:0; }
        .option-label:has(.option-input:checked) { 
            border-color: var(--primary); background: #f5f7ff; 
            box-shadow: 0 4px 12px rgba(67, 56, 202, 0.1); 
        }
        
        .score-display {
            background: var(--gradient-dark); color: white; padding: 25px;
            border-radius: 20px; text-align: center; margin: 30px 0;
            box-shadow: var(--shadow-lg);
        }
        .score-value {
            font-size: 3.5rem; font-weight: 800; margin: 10px 0;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        .cert-input-box input {
            width: 100%; padding: 20px; border-radius: 14px; 
            border: 2px solid var(--border); font-size: 1rem; 
            margin-bottom: 25px; transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }
        .cert-input-box input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.1);
        }

        .hidden { display: none !important; }
        
        /* Trust Badges */
        .trust-badges {
            display: flex; justify-content: center; gap: 30px;
            margin-top: 60px; flex-wrap: wrap;
        }
        .trust-badge {
            display: flex; align-items: center; gap: 10px;
            font-size: 0.9rem; color: var(--text-light);
        }
        .trust-badge i { color: var(--success); font-size: 1.2rem; }
        
        /* Loading Animation */
        .loader { display: none; }
        .loader.active {
            display: block; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(255,255,255,0.9);
            z-index: 2000; display: flex; align-items: center;
            justify-content: center; flex-direction: column; gap: 20px;
        }
        .spinner {
            width: 60px; height: 60px; border: 5px solid #e2e8f0;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Achievement Badge */
        .achievement-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white; padding: 8px 16px; border-radius: 20px;
            font-size: 0.8rem; font-weight: 700; display: inline-flex;
            align-items: center; gap: 5px; margin-left: 10px;
        }
    </style>
</head>
<body>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p style="color: var(--text-main); font-weight: 600;">Loading Module...</p>
    </div>

<header>
        <div class="nav-container">
            <button class="sidebar-toggle" onclick="toggleSidebar()" style="background:none; border:none; cursor:pointer; font-size:1.4rem; display:none; color: var(--text-main);">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="logo-container">
                <i class="fas fa-graduation-cap logo-icon"></i>
                <a href="#" class="logo-text">Intern<span>adda</span></a>
            </div>

            <div class="progress-stats">
                <div class="progress-percent" id="prog-stat-text">0% COMPLETE</div>
            </div>
        </div>
    </header>

    <div class="mobile-progress-container"><div id="progress-fill"></div></div>
    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="toc"></aside>

    <div id="welcome-screen">
        <section class="hero-section">
            <div style="opacity: 0; animation: reveal 0.8s 0.1s forwards;">
                <div class="module-tag"><i class="fas fa-crown"></i> ELITE MASTERY PROGRAM</div>
            </div>
            
            <h1 class="hero-title">Master Excel at an <span style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Expert Level</span></h1>
            <p style="color:var(--text-light); font-size: 1.25rem; margin-bottom: 40px; max-width: 700px; margin-left: auto; margin-right: auto; opacity: 0; animation: reveal 0.8s 0.3s forwards;">
                Engineered for finance professionals, data analysts, and business leaders who want to leverage Excel's full potential for advanced data analysis, automation, and business intelligence.
            </p>
            
            <div class="perks-grid">
                <div class="perk-item"><i class="fas fa-award"></i>Professional Credentials</div>
                <div class="perk-item"><i class="fas fa-table"></i> 50+ Hands-on Exercises</div>
                <div class="perk-item"><i class="fas fa-chart-line"></i> Real-world Business Cases</div>
                <div class="perk-item"><i class="fas fa-certificate"></i> Verified Certificate</div>
            </div>

            <div class="instructor-card">
                <img src="lucky.jpg" alt="Lucky Tiwari" class="instructor-img">
                <div>
                    <span class="badge-verified"><i class="fas fa-shield-alt"></i> VERIFIED INSTRUCTOR</span>
                    <h4 style="font-weight: 800; font-size: 1.2rem; margin-bottom: 5px;">Lucky Tiwari</h4>
                    <p style="font-size: 0.9rem; color: var(--text-light);">Founder of Internadda & Senior Financial Analyst</p>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 8px;">10+ years in financial modeling & Excel automation</p>
                </div>
            </div>

            <div class="trust-badges">
                <div class="trust-badge"><i class="fas fa-check-circle"></i> Industry-recognized</div>
                <div class="trust-badge"><i class="fas fa-clock"></i> Self-paced learning</div>
                <div class="trust-badge"><i class="fas fa-users"></i> 25,000+ Students enrolled</div>
            </div>

            <button class="btn-primary" style="max-width:320px; margin:50px auto 0; opacity: 0; animation: reveal 0.8s 0.8s forwards;" onclick="startCourse()">
                <i class="fas fa-rocket"></i> Start Learning Now
            </button>
        </section>
    </div>

    <div id="course-player" class="hidden">
        <main class="main-layout">
            <div class="content-card">
                <div id="module-content"></div>
                <div id="exam-section" class="hidden quiz-box"></div>
                <div id="final-step-section" class="hidden cert-input-box">
                    <span class="module-tag"><i class="fas fa-trophy"></i> ACHIEVEMENT UNLOCKED</span>
                    <h2 class="mod-title">Claim Your Certificate</h2>
                    <p class="body-text">Congratulations! You've successfully completed all modules and passed the final exam. Your certificate is ready for generation.</p>
                    
                    <div style="background: #f0f9ff; padding: 25px; border-radius: 16px; margin: 30px 0; border-left: 4px solid var(--success);">
                        <h4 style="font-weight: 700; margin-bottom: 10px; color: var(--dark-bg);"><i class="fas fa-certificate"></i> Certificate Details</h4>
                        <p style="color: #475569; margin-bottom: 5px;"><b>Issued by:</b> Internadda Academy</p>
                        <p style="color: #475569; margin-bottom: 5px;"><b>Course:</b> Elite Excel Mastery</p>
                        <p style="color: #475569;"><b>Verification ID:</b> EXCEL-ELITE-${Math.random().toString(36).substr(2, 9).toUpperCase()}</p>
                    </div>
                    
                    <input type="text" id="student-name" placeholder="Enter your full name as it should appear on certificate">
                    <button class="btn-primary" onclick="claimCertificate()">
                        <i class="fas fa-file-certificate"></i> Generate & Download Certificate
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
const syllabus = [
{
    title: "Module 01: Advanced Excel Architecture",
    desc: "Excel Engine, Calculation Methods & Performance Optimization",
    content: `
        <span class="module-tag"><i class="fas fa-cogs"></i> Excel Engine</span>
        <h2 class="mod-title">Excel Calculation Engine, Formulas & Performance Optimization</h2>

        <p class="body-text">
            Welcome to the first module of <b>Elite Excel Mastery</b>. We start by understanding Excel's internal architecture 
            – how it calculates formulas, manages memory, and processes data. By mastering these fundamentals, you'll write 
            spreadsheets that are not just functional but <b>blazing fast and efficient</b>, even with millions of rows.
        </p>

        <div class="pro-note">
            <b><i class="fas fa-lightbulb"></i> Excel Calculation Engine Overview:</b>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li><b>Formula Parsing:</b> Excel converts formulas into calculation trees</li>
                <li><b>Calculation Chain:</b> Determines order of formula calculation</li>
                <li><b>Volatile Functions:</b> Functions that trigger recalculation of entire workbook</li>
                <li><b>Multi-threaded Calculation:</b> Excel 2010+ uses multiple CPU cores</li>
                <li><b>Smart Recalculation:</b> Only recalculates cells affected by changes</li>
            </ul>
        </div>

        <h3 class="section-head">1. Excel Calculation Methods</h3>
        <p class="body-text">
            Excel offers three calculation modes. Understanding when to use each is crucial for performance:
        </p>

        <h4 class="subsection-head">1.1 Calculation Modes</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Mode</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Keyboard Shortcut</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">When to Use</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Automatic (Default)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">F9 recalculates all</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Small workbooks, real-time analysis</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Automatic Except Data Tables</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Alt + M + X</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Workbooks with data tables</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Manual</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">F9 calculates, Shift+F9 sheet only</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Large models, reduce calculation time</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">1.2 Setting Calculation Mode</h4>
        <pre>
' VBA to set calculation mode
Application.Calculation = xlCalculationManual
Application.Calculation = xlCalculationAutomatic
Application.Calculation = xlCalculationSemiautomatic

' Keyboard shortcuts:
' F9: Calculate all worksheets
' Shift + F9: Calculate active worksheet
' Ctrl + Alt + F9: Force full calculation
' Ctrl + Shift + Alt + F9: Rebuild calculation chain
        </pre>

        <h3 class="section-head">2. Formula Evaluation & Calculation Chain</h3>
        <p class="body-text">
            Excel builds a calculation chain to determine formula dependencies and optimize calculation order.
        </p>

        <h4 class="subsection-head">2.1 Formula Evaluation Order</h4>
        <ol style="margin-left: 25px;">
            <li>Excel identifies all formulas that need calculation</li>
            <li>Builds dependency tree (precedents and dependents)</li>
            <li>Calculates in order: no dependencies first, then dependent formulas</li>
            <li>Uses intelligent recalculation to skip unchanged cells</li>
        </ol>

        <h4 class="subsection-head">2.2 Monitoring Calculation Chain</h4>
        <pre>
' View calculation chain in VBA
Sub ViewCalculationChain()
    Dim chain As CalculationChain
    Set chain = Application.CalculationChain
    
    Dim cell As Range
    For Each cell In chain
        Debug.Print cell.Address & ": " & cell.Formula
    Next cell
End Sub

' Evaluate Formula tool (Excel UI)
' Alt + M + V: Opens Evaluate Formula dialog
' Step through formula calculation
        </pre>

        <h3 class="section-head">3. Volatile Functions & Performance Impact</h3>
        <p class="body-text">
            Volatile functions recalculate every time Excel recalculates, even if their arguments haven't changed.
        </p>

        <h4 class="subsection-head">3.1 Common Volatile Functions</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Function</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Volatile?</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Alternative</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">NOW(), TODAY()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Yes</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Static timestamp, refresh manually</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">RAND(), RANDBETWEEN()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Yes</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Copy values, use VBA for control</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">OFFSET(), INDIRECT()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Yes</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">INDEX-MATCH, structured references</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">CELL(), INFO()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Yes</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Specific cell properties only when needed</td></tr>
                </tbody>
            </table>
        </div>

        <h3 class="section-head">4. Memory Management & Limits</h3>
        <p class="body-text">
            Excel has specific memory limits that affect performance:
        </p>

        <h4 class="subsection-head">4.1 Excel Memory Architecture</h4>
        <ul style="margin-left: 25px;">
            <li><b>32-bit Excel:</b> Limited to 2GB RAM (shared with OS)</li>
            <li><b>64-bit Excel:</b> No practical RAM limit (theoretically 8TB)</li>
            <li><b>Worksheet Limits:</b> 1,048,576 rows × 16,384 columns (Excel 2007+)</li>
            <li><b>Cell Styles:</b> Maximum 64,000 unique cell formats</li>
            <li><b>Array Formulas:</b> Limited by available memory</li>
        </ul>

        <h3 class="section-head">5. Performance Optimization Techniques</h3>

        <h4 class="subsection-head">5.1 Formula Optimization</h4>
        <pre>
' BEFORE: Slow, repeated calculation
=IFERROR(VLOOKUP(A2, Data!$A$2:$Z$10000, 5, FALSE), "Not Found") +
 IFERROR(VLOOKUP(A2, Data!$A$2:$Z$10000, 6, FALSE), 0)

' AFTER: Faster, single lookup
=LET(
    lookup_result, XLOOKUP(A2, Data!$A$2:$A$10000, Data!$E$2:$F$10000),
    IF(ISNA(lookup_result), "Not Found", INDEX(lookup_result, 1) + INDEX(lookup_result, 2))
)

' Minimize whole column references
=SUMIFS($C:$C, $A:$A, "Product A")  ' Slow
=SUMIFS($C$2:$C$10000, $A$2:$A$10000, "Product A")  ' Fast

' Use dynamic ranges or Excel Tables
=SUMIFS(Table1[Sales], Table1[Product], "A", Table1[Date], ">"&DATE(2023,1,1))
        </pre>

        <h4 class="subsection-head">5.2 Workbook Structure Optimization</h4>
        <ul style="margin-left: 25px;">
            <li><b>Limit Used Range:</b> Delete unused rows/columns (Ctrl+End to check)</li>
            <li><b>Use Excel Tables:</b> Structured references are more efficient</li>
            <li><b>Avoid Merged Cells:</b> Use Center Across Selection instead</li>
            <li><b>Minimize Formatting:</b> Excessive formatting increases file size</li>
            <li><b>Compress Images:</b> Right-click images → Compress Pictures</li>
        </ul>

        <h3 class="section-head">6. Multi-threaded Calculation</h3>
        <p class="body-text">
            Excel 2010+ supports multi-threaded calculation for better performance on multi-core CPUs.
        </p>

        <h4 class="subsection-head">6.1 Enabling Multi-threading</h4>
        <pre>
' VBA to check and set multi-threading
Sub CheckMultiThreading()
    ' Check if multi-threading is enabled
    Debug.Print "Number of processors: " & Application.NumberOfProcessors
    Debug.Print "Multi-threading enabled: " & Application.MultiThreadedCalculation.Enabled
    Debug.Print "Thread mode: " & Application.MultiThreadedCalculation.ThreadMode
    
    ' Enable multi-threading
    Application.MultiThreadedCalculation.Enabled = True
    Application.MultiThreadedCalculation.ThreadMode = xlThreadModeAutomatic
End Sub

' File → Options → Advanced
' Enable multi-threaded calculation
' Number of calculation threads: (set to 0 for automatic)
        </pre>

        <h3 class="section-head">7. Excel File Formats & Performance</h3>
        <p class="body-text">
            Different Excel file formats have different performance characteristics:
        </p>

        <h4 class="subsection-head">7.1 File Format Comparison</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Format</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Extension</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Max Rows</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Best For</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Excel Binary</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">.xlsb</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">1M+</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Large datasets, fastest performance</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Excel Macro-Enabled</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">.xlsm</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">1M+</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Workbooks with macros</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Excel Workbook</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">.xlsx</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">1M+</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">General use, smaller file size</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Excel 97-2003</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">.xls</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">65,536</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Compatibility only</td></tr>
                </tbody>
            </table>
        </div>

        <h3 class="section-head">8. Advanced Calculation Techniques</h3>

        <h4 class="subsection-head">8.1 Using LET Function for Efficiency</h4>
        <pre>
' Complex calculation without LET
=IF(SUMIFS(Sales, Region, "North", Product, "A") > 100000,
    SUMIFS(Sales, Region, "North", Product, "A") * 0.1,
    SUMIFS(Sales, Region, "North", Product, "A") * 0.05)

' Same calculation with LET (calculates once)
=LET(
    north_sales, SUMIFS(Sales, Region, "North", Product, "A"),
    IF(north_sales > 100000,
        north_sales * 0.1,
        north_sales * 0.05)
)
        </pre>

        <h4 class="subsection-head">8.2 Dynamic Arrays & Spill Ranges</h4>
        <pre>
' Single formula that spills results
=UNIQUE(FILTER(SalesData, (Region="North")*(Sales>10000)))

' Reference spill range
=SUM(SORT(FILTER(SalesData, Sales>50000), 2, -1))

' Handle errors in spill ranges
=IFERROR(
    XLOOKUP(A2:A100, Products!A:A, Products!B:B),
    "Not Found"
)
        </pre>

        <h3 class="section-head">9. Monitoring & Debugging Performance</h3>

        <h4 class="subsection-head">9.1 Performance Tools</h4>
        <ul style="margin-left: 25px;">
            <li><b>Status Bar:</b> Shows calculation progress</li>
            <li><b>Formula Auditing:</b> Trace precedents/dependents (Alt+M+P)</li>
            <li><b>Watch Window:</b> Monitor specific cells during calculation</li>
            <li><b>VBA Timer:</b> Measure calculation time programmatically</li>
            <li><b>Third-party Add-ins:</b> Name Manager, FormulaDesk, etc.</li>
        </ul>

        <h4 class="subsection-head">9.2 VBA Performance Monitoring</h4>
        <pre>
Sub TimeCalculation()
    Dim startTime As Double
    Dim endTime As Double
    
    startTime = Timer
    
    ' Force calculation
    Application.Calculate
    
    endTime = Timer
    
    Debug.Print "Calculation time: " & Format(endTime - startTime, "0.00") & " seconds"
    
    ' Monitor memory usage
    Debug.Print "Memory used: " & Format(Application.MemoryUsed / 1024 / 1024, "0.0") & " MB"
    Debug.Print "Memory total: " & Format(Application.MemoryTotal / 1024 / 1024, "0.0") & " MB"
End Sub
        </pre>

        <h3 class="section-head">10. Best Practices Summary</h3>
        <ul style="margin-left: 25px;">
            <li>Use manual calculation for large workbooks</li>
            <li>Minimize volatile functions</li>
            <li>Use Excel Tables and structured references</li>
            <li>Limit whole column references</li>
            <li>Use .xlsb format for large datasets</li>
            <li>Enable multi-threaded calculation</li>
            <li>Regularly clean unused ranges</li>
            <li>Use LET and dynamic arrays where appropriate</li>
        </ul>

        <div class="pro-note">
            <b><i class="fas fa-arrow-right"></i> Next Steps:</b> In Module 02, we dive into Advanced Formulas & Functions, including array formulas, dynamic arrays, and the new Excel 365 functions that revolutionize spreadsheet calculations.
        </div>

        <button class="btn-premium" onclick="completeModule()">
            <i class="fas fa-lock-open"></i> Unlock Module 02: Advanced Formulas & Functions
        </button>
    `
},

{
    title: "Module 02: Advanced Formulas & Functions",
    desc: "Dynamic Arrays, LAMBDA, LET & Modern Excel Functions",
    content: `
        <span class="module-tag"><i class="fas fa-calculator"></i> Formulas</span>
        <h2 class="mod-title">Dynamic Arrays, LAMBDA, LET & Modern Excel Functions</h2>

        <p class="body-text">
            This module transforms you from an Excel user to an Excel architect. We explore the revolutionary 
            dynamic array functions, custom LAMBDA functions, and optimization techniques that make complex 
            calculations elegant and efficient. These skills separate Excel professionals from Excel experts.
        </p>

        <div class="pro-note">
            <b><i class="fas fa-lightbulb"></i> Pro Tip:</b> Dynamic arrays (Excel 365) eliminate the need for Ctrl+Shift+Enter array formulas and enable single formulas that spill results across multiple cells.
        </div>

        <h3 class="section-head">1. Dynamic Array Revolution</h3>
        <p class="body-text">
            Dynamic arrays automatically spill results across multiple cells, making complex calculations simpler:
        </p>

        <h4 class="subsection-head">1.1 Core Dynamic Array Functions</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Function</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Description</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Example</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">FILTER()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Filter data based on criteria</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">=FILTER(A2:B100, B2:B100>1000)</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">SORT()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Sort range by columns</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">=SORT(A2:B100, 2, -1)</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">UNIQUE()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Return unique values</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">=UNIQUE(A2:A1000)</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">SEQUENCE()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Generate number sequences</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">=SEQUENCE(10, 5, 100, 10)</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">RANDARRAY()</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Array of random numbers</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">=RANDARRAY(5, 3, 1, 100)</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">1.2 FILTER Function Deep Dive</h4>
        <pre>
' Basic FILTER with single condition
=FILTER(SalesData, Region="North")

' Multiple conditions with multiplication (AND logic)
=FILTER(SalesData, (Region="North")*(Sales>10000)*(Quarter="Q4"))

' OR logic with addition
=FILTER(SalesData, (Region="North")+(Region="South"))

' FILTER with error handling
=IFERROR(
    FILTER(SalesData, (Region=A1)*(Sales>B1)),
    "No matches found"
)

' FILTER with SORT and UNIQUE
=SORT(UNIQUE(FILTER(Products, (Category="Electronics")*(Price>500))), , -1)
        </pre>

        <h3 class="section-head">2. LET Function - Name Values in Formulas</h3>
        <p class="body-text">
            LET allows you to assign names to calculation results within a formula, improving readability and performance.
        </p>

        <h4 class="subsection-head">2.1 LET Function Structure</h4>
        <pre>
' Basic LET structure
=LET(
    name1, value1,
    name2, value2,
    calculation_using_names
)

' Real-world example: Complex commission calculation
=LET(
    sales, SUMIFS(SalesData[Amount], SalesData[Salesperson], A2),
    target, VLOOKUP(A2, Targets, 2, FALSE),
    achievement, sales/target,
    base_commission, sales * 0.05,
    bonus, IF(achievement > 1.2, sales * 0.1, 0),
    total_commission, base_commission + bonus,
    total_commission
)

' Nested LET for complex logic
=LET(
    revenue, SUM(RevenueData),
    costs, SUM(CostData),
    gross_margin, (revenue - costs)/revenue,
    LET(
        category, IF(gross_margin > 0.4, "High", "Low"),
        category & " Margin: " & TEXT(gross_margin, "0.0%")
    )
)
        </pre>

        <h3 class="section-head">3. LAMBDA - Create Custom Functions</h3>
        <p class="body-text">
            LAMBDA allows you to create reusable custom functions without VBA, revolutionizing Excel development.
        </p>

        <h4 class="subsection-head">3.1 Basic LAMBDA Examples</h4>
        <pre>
' Simple LAMBDA function
=LAMBDA(x, y, x * y)(5, 10)  ' Returns 50

' Named LAMBDA function (Define Name in Name Manager)
' Name: CalculateTax
' Refers to: =LAMBDA(amount, tax_rate, amount * tax_rate)
' Usage: =CalculateTax(A2, 0.18)

' Complex LAMBDA: Calculate compound interest
=LAMBDA(principal, rate, periods,
    LET(
        multiplier, 1 + rate/periods,
        principal * multiplier ^ periods
    )
)(10000, 0.05, 12)

' Recursive LAMBDA (Excel 365 only)
' Name: Factorial
' Refers to: =LAMBDA(n, IF(n<=1, 1, n * Factorial(n-1)))
' Usage: =Factorial(5)  ' Returns 120
        </pre>

        <h3 class="section-head">4. XLOOKUP - The Ultimate Lookup Function</h3>
        <p class="body-text">
            XLOOKUP replaces VLOOKUP, HLOOKUP, and INDEX/MATCH with a single, powerful function.
        </p>

        <h4 class="subsection-head">4.1 XLOOKUP Mastery</h4>
        <pre>
' Basic XLOOKUP (replaces VLOOKUP)
=XLOOKUP(lookup_value, lookup_array, return_array)

' Two-way lookup (replaces INDEX/MATCH)
=XLOOKUP(lookup_value, lookup_array, 
         XLOOKUP(column_header, column_headers, return_matrix))

' Approximate match with wildcards
=XLOOKUP("*" & partial_text & "*", lookup_array, return_array, "Not Found", 2)

' Multiple return columns
=XLOOKUP(A2, Products[ID], Products[[Name]:[Price]])  ' Returns both Name and Price

' Dynamic array result
=XLOOKUP(A2:A10, Customers[ID], Customers[[Name]:[Email]])

' Reverse search (search from bottom)
=XLOOKUP(A2, lookup_array, return_array, , , -1)

' Error handling built-in
=XLOOKUP(A2, lookup_array, return_array, "Not Found", 0, 1)
        </pre>

        <h3 class="section-head">5. TEXT Functions & Dynamic Formatting</h3>

        <h4 class="subsection-head">5.1 Advanced TEXT Manipulation</h4>
        <pre>
' TEXTJOIN with delimiter and filtering
=TEXTJOIN(", ", TRUE, 
    FILTER(Employees[Name], 
        (Employees[Department]="Sales")*
        (Employees[Hire_Date]>=DATE(2023,1,1))
    )
)

' Extract specific text patterns
=LET(
    text, A2,
    pattern, "[A-Z]{2}-[0-9]{4}",
    IF(REGEXMATCH(text, pattern),
        REGEXEXTRACT(text, pattern),
        "Invalid format"
    )
)

' Dynamic number formatting
=TEXT(SUM(Sales), "#,##0") & " units"
=TEXT(AVERAGE(Ratings), "0.0") & " stars"
=TEXT(NOW(), "yyyy-mm-dd hh:mm:ss")

' CONCAT with dynamic arrays
=CONCAT(
    TEXT(SEQUENCE(12), "mmm") & " " & 
    TEXT(SEQUENCE(12), "[$-en-US]mmmm")
)
        </pre>

        <h3 class="section-head">6. Logical & Information Functions</h3>

        <h4 class="subsection-head">6.1 Advanced Logical Functions</h4>
        <pre>
' IFS for multiple conditions (replaces nested IF)
=IFS(
    A2>=90, "A",
    A2>=80, "B",
    A2>=70, "C",
    A2>=60, "D",
    TRUE, "F"
)

' SWITCH for exact matches
=SWITCH(A2,
    "NY", "New York",
    "CA", "California",
    "TX", "Texas",
    "Other State"
)

' FILTER with multiple OR conditions
=FILTER(Data, 
    (Region="North") + (Region="South") + (Region="East")
)

' Complex logical array
=LET(
    scores, B2:B100,
    weights, C2:C100,
    weighted_avg, SUMPRODUCT(scores, weights)/SUM(weights),
    IF(weighted_avg >= 70, "Pass", "Fail")
)
        </pre>

        <h3 class="section-head">7. Date & Time Functions</h3>

        <h4 class="subsection-head">7.1 Modern Date Calculations</h4>
        <pre>
' SEQUENCE for date ranges
=SEQUENCE(365, 1, DATE(2023,1,1), 1)  ' All dates in 2023

' WORKDAY.INTL with custom weekends
=WORKDAY.INTL(start_date, days, "0000011", holidays)  ' Sun-Mon weekend

' DATEDIF with dynamic arrays
=LET(
    start_dates, A2:A100,
    end_dates, B2:B100,
    DATEDIF(start_dates, end_dates, "Y") & "y " &
    DATEDIF(start_dates, end_dates, "YM") & "m"
)

' EOMONTH with sequence
=EOMONTH(SEQUENCE(12, 1, DATE(2023,1,1)), 0)  ' End of each month

' Dynamic fiscal year calculation
=LET(
    date, A2,
    fy_start_month, 4,  ' April
    YEAR(date) + IF(MONTH(date) >= fy_start_month, 1, 0)
)
        </pre>

        <h3 class="section-head">8. Statistical & Math Functions</h3>

        <h4 class="subsection-head">8.1 Advanced Statistical Analysis</h4>
        <pre>
' AGGREGATE for filtered data
=AGGREGATE(14, 6, Sales/(Region="North"), k)  ' kth largest for North

' PERCENTILE.INC with conditions
=LET(
    north_sales, FILTER(Sales, Region="North"),
    PERCENTILE.INC(north_sales, 0.95)
)

' Dynamic correlation matrix
=LET(
    data_range, A2:E100,
    corr_matrix, CORREL(OFFSET(data_range, , {0,1,2,3}), 
                         OFFSET(data_range, , {0,1,2,3})),
    corr_matrix
)

' Monte Carlo simulation with RANDARRAY
=LET(
    simulations, 10000,
    returns, NORM.INV(RANDARRAY(simulations), mean_return, std_dev),
    PERCENTILE.INC(returns, {0.05, 0.5, 0.95})
)
        </pre>

        <h3 class="section-head">9. Combining Functions for Power Solutions</h3>

        <h4 class="subsection-head">9.1 Real-World Business Solutions</h4>
        <pre>
' Dynamic dashboard formula
=LET(
    selected_region, Dashboard!B2,
    selected_product, Dashboard!B3,
    start_date, Dashboard!B4,
    end_date, Dashboard!B5,
    
    filtered_data, FILTER(SalesData,
        (Region=selected_region)*
        (Product=selected_product)*
        (Date>=start_date)*
        (Date<=end_date)),
    
    IF(ROWS(filtered_data)=0,
        "No data for selected criteria",
        LET(
            total_sales, SUM(INDEX(filtered_data, , 3)),
            avg_sale, AVERAGE(INDEX(filtered_data, , 3)),
            transactions, ROWS(filtered_data),
            
            HSTACK(
                {"Total Sales", "Average Sale", "Transactions"},
                {total_sales, avg_sale, transactions}
            )
        )
    )
)

' Automated report generation
=LET(
    departments, UNIQUE(Employees[Department]),
    headcounts, COUNTIFS(Employees[Department], departments),
    avg_salaries, AVERAGEIFS(Employees[Salary], Employees[Department], departments),
    
    SORT(
        HSTACK(departments, headcounts, avg_salaries),
        2, -1  ' Sort by headcount descending
    )
)
        </pre>

        <h3 class="section-head">10. Performance & Best Practices</h3>
        <ul style="margin-left: 25px;">
            <li>Use LET to store intermediate calculations and improve performance</li>
            <li>Create named LAMBDA functions for frequently used calculations</li>
            <li>Use dynamic arrays instead of manual cell references</li>
            <li>Combine FILTER, SORT, UNIQUE for data processing pipelines</li>
            <li>Use XLOOKUP instead of VLOOKUP for better performance and flexibility</li>
            <li>Test formulas with Evaluate Formula tool (Alt+M+V)</li>
            <li>Document complex formulas with comments (N key in formula bar)</li>
        </ul>

        <div class="pro-note">
            <b><i class="fas fa-tools"></i> Pro Tip:</b> Master the combination of LET, LAMBDA, and dynamic array functions. This trio enables you to build Excel solutions that were previously only possible with VBA or external tools.
        </div>

        <button class="btn-premium" onclick="completeModule()">
            <i class="fas fa-lock-open"></i> Unlock Module 03: Data Analysis & Power Query
        </button>
    `
},
{
    title: "Module 03: Power Query & Data Transformation",
    desc: "ETL, Data Cleaning, Merging & Advanced Data Import",
    content: `
        <span class="module-tag"><i class="fas fa-database"></i> Data Transformation</span>
        <h2 class="mod-title">Power Query: ETL, Data Cleaning, Merging & Advanced Data Import</h2>

        <p class="body-text">
            Power Query is Excel's revolutionary data transformation engine. This module teaches you to connect to any data source, 
            clean and transform data with zero formulas, and build automated data pipelines. Mastering Power Query means you'll 
            never manually clean data again.
        </p>

        <div class="pro-note">
            <b><i class="fas fa-lightbulb"></i> Pro Tip:</b> Power Query processes data outside Excel's grid, allowing you to transform millions of rows without slowing down your workbook.
        </div>

        <h3 class="section-head">1. Power Query Architecture</h3>
        <p class="body-text">
            Understanding how Power Query works under the hood:
        </p>

        <h4 class="subsection-head">1.1 Power Query Components</h4>
        <ul style="margin-left: 25px;">
            <li><b>Query Editor:</b> Interactive interface for data transformation</li>
            <li><b>M Language:</b> Functional programming language behind Power Query</li>
            <li><b>Query Folding:</b> Pushing operations back to data source when possible</li>
            <li><b>Data Model:</b> In-memory columnar database (Power Pivot)</li>
            <li><b>Refresh:</b> Update queries with latest source data</li>
        </ul>

        <h4 class="subsection-head">1.2 Accessing Power Query</h4>
        <pre>
' Keyboard shortcuts:
' Alt + A + P + T: Get Data from Table/Range
' Alt + A + P + V: Launch Power Query Editor
' Alt + A + P + R: Refresh All Queries

' Data Sources:
' 1. Excel Workbook (tables, ranges, sheets)
' 2. CSV/TXT Files
' 3. Databases (SQL Server, Oracle, MySQL)
' 4. Web Pages
' 5. APIs (JSON, XML)
' 6. SharePoint
' 7. Cloud Services (Azure, AWS, Google)
' 8. Folder (combine multiple files)
        </pre>

        <h3 class="section-head">2. Basic Data Transformation</h3>

        <h4 class="subsection-head">2.1 Essential Transformations</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Transformation</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Power Query UI</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">M Code Equivalent</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Remove Duplicates</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Right-click column → Remove Duplicates</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Table.Distinct</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Change Data Type</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Data Type button in ribbon</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Table.TransformColumnTypes</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Filter Rows</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Filter dropdown in column header</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Table.SelectRows</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Split Column</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Transform → Split Column</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Table.SplitColumn</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Group By</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Transform → Group By</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Table.Group</td></tr>
                </tbody>
            </table>
        </div>

        <h3 class="section-head">3. Advanced M Language</h3>
        <p class="body-text">
            M is Power Query's functional programming language. While the UI handles 90% of tasks, knowing M unlocks the remaining 10%.
        </p>

        <h4 class="subsection-head">3.1 M Language Fundamentals</h4>
        <pre>
' Basic M syntax
let
    Source = Excel.CurrentWorkbook(){[Name="Table1"]}[Content],
    ChangedType = Table.TransformColumnTypes(Source,{{"Column1", type text}}),
    FilteredRows = Table.SelectRows(ChangedType, each [Column1] <> null)
in
    FilteredRows

' Custom column with M
= Table.AddColumn(
    PreviousStep,
    "FullName",
    each [FirstName] & " " & [LastName],
    type text
)

' Conditional column
= Table.AddColumn(
    PreviousStep,
    "Status",
    each if [Sales] > 10000 then "High" else "Low",
    type text
)

' Date calculations
= Table.AddColumn(
    PreviousStep,
    "DaysSinceOrder",
    each Duration.Days(DateTime.Date(DateTime.LocalNow()) - [OrderDate]),
    Int64.Type
)
        </pre>

        <h4 class="subsection-head">3.2 Advanced M Functions</h4>
        <pre>
' Text extraction with patterns
= Table.TransformColumns(
    PreviousStep,
    {{"Email", each Text.BetweenDelimiters(_, "@", "."), type text}}
)

' List operations
= Table.AddColumn(
    PreviousStep,
    "AverageScore",
    each List.Average({[Math], [Science], [English]}),
    type number
)

' Error handling
= Table.ReplaceErrorValues(
    PreviousStep,
    {{"Revenue", 0}, {"Cost", null}}
)

' Custom function in M
let
    CalculateTax = (amount) => amount * 0.18,
    Source = Table1,
    AddedTax = Table.AddColumn(Source, "Tax", each CalculateTax([Amount]))
in
    AddedTax
        </pre>

        <h3 class="section-head">4. Combining Data Sources</h3>

        <h4 class="subsection-head">4.1 Merge Queries (Joins)</h4>
        <pre>
' Different join types in Power Query
' 1. Inner Join: Only matching rows from both tables
' 2. Left Outer: All rows from first, matching from second
' 3. Right Outer: All rows from second, matching from first
' 4. Full Outer: All rows from both tables
' 5. Left Anti: Rows from first not in second
' 6. Right Anti: Rows from second not in first

' M code for merge
= Table.NestedJoin(
    Customers, 
    {"CustomerID"},
    Orders, 
    {"CustomerID"},
    "Orders",
    JoinKind.LeftOuter
)

' Expanding merged columns
= Table.ExpandTableColumn(
    MergedTable,
    "Orders",
    {"OrderDate", "Amount"},
    {"OrderDate", "OrderAmount"}
)
        </pre>

        <h4 class="subsection-head">4.2 Append Queries (Unions)</h4>
        <pre>
' Append multiple tables with same structure
= Table.Combine({Sales2019, Sales2020, Sales2021, Sales2022})

' Append with different structures
= Table.Combine({
    Table.SelectColumns(Sales2019, {"Date", "Amount", "Region"}),
    Table.SelectColumns(Sales2020, {"OrderDate", "Total", "Area"}),
    Table.SelectColumns(Sales2021, {"TransactionDate", "Revenue", "Location"})
})

' Parameterized append
let
    YearList = {2019, 2020, 2021, 2022},
    Combined = Table.Combine(
        List.Transform(
            YearList,
            each Excel.Workbook(File.Contents("Sales_" & Text.From(_) & ".xlsx")){[Item="Sheet1"]}[Data]
        )
    )
in
    Combined
        </pre>

        <h3 class="section-head">5. Parameterized Queries</h3>
        <p class="body-text">
            Create dynamic queries that adjust based on parameters for flexible data processing.
        </p>

        <h4 class="subsection-head">5.1 Creating Parameters</h4>
        <pre>
' Create parameter from Home → Manage Parameters
' Name: StartDate
' Type: Date
' Current Value: 2023-01-01

' Use parameter in query
let
    Source = Sql.Database("Server", "Database"),
    Sales = Source{[Schema="dbo", Item="Sales"]}[Data],
    Filtered = Table.SelectRows(Sales, each [OrderDate] >= StartDate)
in
    Filtered

' Dynamic file path
let
    FolderPath = "C:\\Reports\\" & Text.From(Date.Year(DateTime.LocalNow())) & "\\",
    Source = Folder.Files(FolderPath),
    Filtered = Table.SelectRows(Source, each Text.Contains([Name], "Sales"))
in
    Filtered

' User-defined function with parameters
let
    GetSalesData = (startDate as date, endDate as date) =>
    let
        Source = Sql.Database("Server", "Database"),
        Sales = Source{[Schema="dbo", Item="Sales"]}[Data],
        Filtered = Table.SelectRows(Sales, each 
            [OrderDate] >= startDate and [OrderDate] <= endDate)
    in
        Filtered
in
    GetSalesData
        </pre>

        <h3 class="section-head">6. Advanced Data Import Patterns</h3>

        <h4 class="subsection-head">6.1 Web Scraping with Power Query</h4>
        <pre>
' Import data from website
let
    Source = Web.Page(Web.Contents("https://example.com/data")),
    DataTable = Source{0}[Data],
    PromotedHeaders = Table.PromoteHeaders(DataTable, [PromoteAllScalars=true])
in
    PromotedHeaders

' API calls with authentication
let
    Source = Json.Document(
        Web.Contents(
            "https://api.example.com/data",
            [
                Headers = [
                    #"Authorization" = "Bearer " & apiKey,
                    #"Content-Type" = "application/json"
                ]
            ]
        )
    ),
    Converted = Table.FromRecords(Source[data])
in
    Converted

' Dynamic web queries
let
    BaseURL = "https://api.example.com/sales?year=",
    Years = {2020, 2021, 2022, 2023},
    Combined = Table.Combine(
        List.Transform(
            Years,
            each Json.Document(
                Web.Contents(BaseURL & Text.From(_))
            )
        )
    )
in
    Combined
        </pre>

        <h4 class="subsection-head">6.2 Folder Import & File Combining</h4>
        <pre>
' Import all files from folder
let
    Source = Folder.Files("C:\\Reports\\"),
    Filtered = Table.SelectRows(Source, each Text.EndsWith([Name], ".xlsx")),
    Combined = Table.Combine(
        List.Transform(
            Filtered[Content],
            each Excel.Workbook(_){[Item="Sheet1"]}[Data]
        )
    )
in
    Combined

' Import with file metadata
let
    Source = Folder.Files("C:\\Reports\\"),
    AddedMetadata = Table.AddColumn(Source, "Data", each 
        Table.AddColumn(
            Excel.Workbook([Content]){[Item="Sheet1"]}[Data],
            "FileName",
            each [Name]
        )
    ),
    Expanded = Table.ExpandTableColumn(AddedMetadata, "Data", 
        Table.ColumnNames(AddedMetadata[Data]{0})),
    RemovedColumns = Table.RemoveColumns(Expanded, {"Content", "Extension"})
in
    RemovedColumns
        </pre>

        <h3 class="section-head">7. Data Quality & Error Handling</h3>

        <h4 class="subsection-head">7.1 Data Validation Patterns</h4>
        <pre>
' Validate email format
= Table.AddColumn(
    PreviousStep,
    "IsValidEmail",
    each Text.Contains([Email], "@") and Text.Contains([Email], "."),
    type logical
)

' Check for required fields
= Table.AddColumn(
    PreviousStep,
    "MissingFields",
    each 
        List.Count(
            List.RemoveItems(
                {"Name", "Email", "Phone"},
                Record.FieldNames(_)
            )
        ) > 0,
    type logical
)

' Data quality score
= Table.AddColumn(
    PreviousStep,
    "DataQualityScore",
    each 
        let
            validEmail = if Text.Contains([Email], "@") then 1 else 0,
            validPhone = if Text.Length([Phone]) >= 10 then 1 else 0,
            validName = if not Text.Contains([Name], "?") then 1 else 0
        in
            (validEmail + validPhone + validName) / 3,
    type number
)
        </pre>

        <h3 class="section-head">8. Performance Optimization</h3>

        <h4 class="subsection-head">8.1 Query Folding</h4>
        <pre>
' Operations that fold to SQL Server
' Filtering, sorting, grouping, joining when:
' 1. Using native database connector
' 2. Operations are supported by database
' 3. No custom M functions break folding

' Check if query folds (View Native Query)
let
    Source = Sql.Database("Server", "Database"),
    Sales = Source{[Schema="dbo", Item="Sales"]}[Data],
    Filtered = Table.SelectRows(Sales, each [Amount] > 1000),
    Grouped = Table.Group(Filtered, {"Region"}, {{"Total", each List.Sum([Amount]), type number}})
in
    Grouped
' Native Query (SQL generated):
' SELECT [Region], SUM([Amount]) as Total 
' FROM [Sales] 
' WHERE [Amount] > 1000 
' GROUP BY [Region]

' Operations that break folding:
' 1. Text transformations with custom M
' 2. Adding custom columns with complex logic
' 3. Certain date/time calculations
        </pre>

        <h4 class="subsection-head">8.2 Incremental Refresh</h4>
        <pre>
' Setup for incremental refresh (Power BI Premium/Pro)
' 1. Enable incremental refresh on query
' 2. Define date range parameters
' 3. Set refresh policy

let
    Source = Sql.Database("Server", "Database"),
    Sales = Source{[Schema="dbo", Item="Sales"]}[Data],
    Filtered = Table.SelectRows(Sales, each 
        [OrderDate] >= RangeStart and [OrderDate] < RangeEnd)
in
    Filtered

' Manual incremental pattern
let
    Source = Sql.Database("Server", "Database"),
    Sales = Source{[Schema="dbo", Item="Sales"]}[Data],
    LastRefresh = #date(2023, 12, 1),
    NewData = Table.SelectRows(Sales, each [OrderDate] > LastRefresh),
    ExistingData = Excel.CurrentWorkbook(){[Name="HistoricalSales"]}[Content],
    Combined = Table.Combine({ExistingData, NewData})
in
    Combined
        </pre>

        <h3 class="section-head">9. Real-World Business Applications</h3>

        <h4 class="subsection-head">9.1 Automated Sales Report</h4>
        <pre>
' Complete sales report pipeline
let
    // Step 1: Import sales data
    SalesData = Excel.Workbook(File.Contents("SalesData.xlsx")){[Item="RawData"]}[Data],
    
    // Step 2: Clean and transform
    CleanedData = Table.TransformColumnTypes(SalesData,
        {{"OrderDate", type date}, {"Amount", Currency.Type}}),
    
    // Step 3: Import product catalog
    Products = Excel.Workbook(File.Contents("Products.xlsx")){[Item="Catalog"]}[Data],
    
    // Step 4: Merge with product info
    Merged = Table.NestedJoin(CleanedData, {"ProductID"}, 
                              Products, {"ProductID"}, "ProductInfo", JoinKind.LeftOuter),
    Expanded = Table.ExpandTableColumn(Merged, "ProductInfo", 
                                       {"ProductName", "Category", "Cost"}, 
                                       {"ProductName", "Category", "Cost"}),
    
    // Step 5: Calculate metrics
    AddedColumns = Table.AddColumn(Expanded, "Profit", each [Amount] - [Cost]),
    AddedColumns2 = Table.AddColumn(AddedColumns, "Month", 
                                    each Date.ToText([OrderDate], "yyyy-MM"), type text),
    
    // Step 6: Aggregate by month and category
    Grouped = Table.Group(AddedColumns2, {"Month", "Category"}, {
        {"Sales", each List.Sum([Amount]), Currency.Type},
        {"Profit", each List.Sum([Profit]), Currency.Type},
        {"Transactions", each Table.RowCount(_), Int64.Type}
    }),
    
    // Step 7: Sort and finalize
    Sorted = Table.Sort(Grouped, {{"Month", Order.Descending}, {"Category", Order.Ascending}})
in
    Sorted
        </pre>

        <h3 class="section-head">10. Best Practices</h3>
        <ul style="margin-left: 25px;">
            <li>Use query folding whenever possible for performance</li>
            <li>Build queries in logical steps for maintainability</li>
            <li>Use parameters for dynamic queries</li>
            <li>Document queries with comments in Advanced Editor</li>
            <li>Test queries with small datasets first</li>
            <li>Use error handling for robust data pipelines</li>
            <li>Schedule refreshes for automated reporting</li>
            <li>Store credentials securely</li>
        </ul>

        <div class="pro-note">
            <b><i class="fas fa-tools"></i> Pro Tip:</b> Power Query is not just for importing data. Use it as a data preparation layer that feeds into Excel formulas, PivotTables, and Power Pivot for end-to-end analytics solutions.
        </div>

        <button class="btn-premium" onclick="completeModule()">
            <i class="fas fa-lock-open"></i> Unlock Module 04: Power Pivot & DAX
        </button>
    `
},
{
    title: "Module 04: Power Pivot & DAX",
    desc: "Data Modeling, DAX Formulas & Advanced Calculations",
    content: `
        <span class="module-tag"><i class="fas fa-cube"></i> Data Modeling</span>
        <h2 class="mod-title">Power Pivot: Data Modeling, DAX Formulas & Advanced Calculations</h2>

        <p class="body-text">
            Power Pivot is Excel's in-memory analytical engine that handles millions of rows with lightning speed. 
            Combined with DAX (Data Analysis Expressions), it enables sophisticated business intelligence, complex calculations, 
            and interactive reports that would be impossible with standard Excel.
        </p>

        <div class="pro-note">
            <b><i class="fas fa-lightbulb"></i> Pro Tip:</b> DAX looks like Excel formulas but works fundamentally differently. It operates on entire columns and tables, not individual cells.
        </div>

        <h3 class="section-head">1. Power Pivot Architecture</h3>
        <p class="body-text">
            Understanding the columnar database engine behind Power Pivot:
        </p>

        <h4 class="subsection-head">1.1 How Power Pivot Works</h4>
        <ul style="margin-left: 25px;">
            <li><b>Columnar Storage:</b> Data stored by columns, not rows (like VertiPaq)</li>
            <li><b>Data Compression:</b> Advanced compression for 10x smaller memory footprint</li>
            <li><b>Relationship Engine:</b> Manages star/snowflake schemas</li>
            <li><b>In-Memory Processing:</b> All data loaded into RAM for instant calculations</li>
            <li><b>DirectQuery:</b> Option to query data source directly (for very large datasets)</li>
        </ul>

        <h4 class="subsection-head">1.2 Enabling Power Pivot</h4>
        <pre>
' Enable Power Pivot Add-in:
' File → Options → Add-ins
' Manage: COM Add-ins → Go
' Check: Microsoft Power Pivot for Excel

' Keyboard shortcuts:
' Alt + Y + P + P: Open Power Pivot window
' Alt + Y + P + T: Create PivotTable from Data Model
' Alt + Y + P + C: Create PivotChart from Data Model

' Import data into Power Pivot:
' 1. From Excel tables/ranges
' 2. From Power Query queries
' 3. From databases (SQL Server, Oracle, etc.)
' 4. From text files
' 5. From data feeds
        </pre>

        <h3 class="section-head">2. Data Modeling Fundamentals</h3>

        <h4 class="subsection-head">2.1 Star Schema Design</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Table Type</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Purpose</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Characteristics</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Fact Tables</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Store transactional data</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Many rows, numeric measures, foreign keys</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Dimension Tables</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Store descriptive attributes</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Fewer rows, text attributes, primary keys</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Date Tables</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Time intelligence</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Continuous dates, date attributes</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Bridge Tables</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Many-to-many relationships</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Link between fact and dimension</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">2.2 Creating Relationships</h4>
        <pre>
' Auto-detect relationships (Power Pivot window)
' Diagram View → Autodetect

' Manual relationship creation
' 1. Drag from foreign key (Fact table) to primary key (Dimension table)
' 2. Set relationship properties:
'    - Active/Inactive
'    - Cross Filter Direction: Both or Single
'    - Cardinality: One-to-Many or Many-to-One

' DAX to create relationships
= CROSSFILTER(FactSales[CustomerID], DimCustomer[CustomerID], BOTH)

' Many-to-many relationships
' Use bridge table with two one-to-many relationships
' FactTable → BridgeTable (one-to-many)
' BridgeTable → DimensionTable (one-to-many)
        </pre>

        <h3 class="section-head">3. DAX Fundamentals</h3>
        <p class="body-text">
            DAX is a functional language with two main types of calculations: calculated columns and measures.
        </p>

        <h4 class="subsection-head">3.1 Calculated Columns vs Measures</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Aspect</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Calculated Columns</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Measures</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Storage</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Stored in model</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Calculated at query time</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Performance</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Increases model size</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Better for large datasets</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Use Case</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Row-level calculations</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Aggregations, KPIs</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Context</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Row context only</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Filter context + row context</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">3.2 Basic DAX Syntax</h4>
        <pre>
' Calculated column syntax
Total Sales = Sales[Quantity] * Sales[Unit Price]

' Measure syntax (explicit)
Total Revenue := SUM(Sales[Amount])

' Measure with formatting
Profit Margin := 
DIVIDE(
    SUM(Sales[Profit]),
    SUM(Sales[Revenue]),
    0
)

' Using variables for readability
Total Sales YTD := 
VAR CurrentYear = YEAR(TODAY())
RETURN
    CALCULATE(
        SUM(Sales[Amount]),
        Sales[Year] = CurrentYear
    )
        </pre>

        <h3 class="section-head">4. Core DAX Functions</h3>

        <h4 class="subsection-head">4.1 Aggregation Functions</h4>
        <pre>
' Basic aggregations
Total Sales := SUM(Sales[Amount])
Average Price := AVERAGE(Products[Price])
Transaction Count := COUNTROWS(Sales)
Unique Customers := DISTINCTCOUNT(Sales[CustomerID])

' Conditional aggregations
High Value Sales := 
CALCULATE(
    SUM(Sales[Amount]),
    Sales[Amount] > 10000
)

' Semi-additive measures
Closing Stock := 
CALCULATE(
    SUM(Inventory[Quantity]),
    LASTDATE(Inventory[Date])
)

' Time intelligence aggregations
Sales MTD := TOTALMTD(SUM(Sales[Amount]), Calendar[Date])
Sales YTD := TOTALYTD(SUM(Sales[Amount]), Calendar[Date])
Sales PY := CALCULATE(SUM(Sales[Amount]), SAMEPERIODLASTYEAR(Calendar[Date]))
        </pre>

        <h4 class="subsection-head">4.2 Filter Functions</h4>
        <pre>
' CALCULATE - The most important DAX function
Sales in Region A := 
CALCULATE(
    SUM(Sales[Amount]),
    Region[RegionName] = "A"
)

' Multiple filters
Sales in Region A for Product X := 
CALCULATE(
    SUM(Sales[Amount]),
    Region[RegionName] = "A",
    Product[ProductName] = "X"
)

' FILTER function
High Value Customers := 
CALCULATE(
    DISTINCTCOUNT(Sales[CustomerID]),
    FILTER(
        Sales,
        Sales[Amount] > 10000
    )
)

' ALL function (remove filters)
Total Sales All Regions := 
CALCULATE(
    SUM(Sales[Amount]),
    ALL(Region)
)

' Percentage of total
Sales % of Total := 
DIVIDE(
    SUM(Sales[Amount]),
    CALCULATE(SUM(Sales[Amount]), ALL(Sales))
)
        </pre>

        <h3 class="section-head">5. Time Intelligence Functions</h3>

        <h4 class="subsection-head">5.1 Date Table Requirements</h4>
        <pre>
' Date table must have:
' 1. Continuous dates (no gaps)
' 2. One row per day
' 3. Date column of data type Date
' 4. Mark as Date Table (Table Design → Mark as Date Table)

' Create date table with DAX
DateTable = 
ADDCOLUMNS(
    CALENDARAUTO(),
    "Year", YEAR([Date]),
    "Quarter", "Q" & QUARTER([Date]),
    "Month", FORMAT([Date], "MMMM"),
    "MonthNumber", MONTH([Date]),
    "Weekday", FORMAT([Date], "dddd"),
    "WeekNumber", WEEKNUM([Date]),
    "IsWorkingDay", 
        IF(WEEKDAY([Date], 2) < 6, TRUE, FALSE)
)
        </pre>

        <h4 class="subsection-head">5.2 Time Intelligence Patterns</h4>
        <pre>
' Month-to-Date
Sales MTD := TOTALMTD(SUM(Sales[Amount]), Calendar[Date])

' Quarter-to-Date
Sales QTD := TOTALQTD(SUM(Sales[Amount]), Calendar[Date])

' Year-to-Date
Sales YTD := TOTALYTD(SUM(Sales[Amount]), Calendar[Date])

' Previous Period Comparisons
Sales Previous Month := 
CALCULATE(
    SUM(Sales[Amount]),
    PREVIOUSMONTH(Calendar[Date])
)

Sales YoY Growth := 
VAR CurrentSales = SUM(Sales[Amount])
VAR PreviousYearSales = 
    CALCULATE(
        SUM(Sales[Amount]),
        SAMEPERIODLASTYEAR(Calendar[Date])
    )
RETURN
    DIVIDE(CurrentSales - PreviousYearSales, PreviousYearSales)

' Rolling 12 months
Sales Rolling 12M := 
CALCULATE(
    SUM(Sales[Amount]),
    DATESINPERIOD(
        Calendar[Date],
        LASTDATE(Calendar[Date]),
        -12,
        MONTH
    )
)

' Moving average (3 months)
Moving Average 3M := 
AVERAGEX(
    DATESINPERIOD(
        Calendar[Date],
        LASTDATE(Calendar[Date]),
        -3,
        MONTH
    ),
    CALCULATE(SUM(Sales[Amount]))
)
        </pre>

        <h3 class="section-head">6. Advanced DAX Patterns</h3>

        <h4 class="subsection-head">6.1 Ranking & Segmentation</h4>
        <pre>
' Rank customers by sales
Customer Rank := 
RANKX(
    ALL(Customer[CustomerName]),
    [Total Sales]
)

' Top N customers
Top 5 Customers Sales := 
CALCULATE(
    [Total Sales],
    TOPN(
        5,
        VALUES(Customer[CustomerName]),
        [Total Sales]
    )
)

' Customer segmentation
Customer Segment := 
SWITCH(
    TRUE(),
    [Total Sales] >= 100000, "Platinum",
    [Total Sales] >= 50000, "Gold",
    [Total Sales] >= 10000, "Silver",
    "Bronze"
)

' Pareto analysis (80/20 rule)
Pareto Customers := 
VAR TotalSales = [Total Sales]
VAR RunningTotal = 
    CALCULATE(
        [Total Sales],
        FILTER(
            ALL(Customer[CustomerName]),
            [Total Sales] >= TotalSales
        )
    )
VAR PercentOfTotal = RunningTotal / [Total Sales All]
RETURN
    IF(PercentOfTotal <= 0.8, "Key Customers", "Others")
        </pre>

        <h4 class="subsection-head">6.2 Dynamic Measures</h4>
        <pre>
' What-if parameter
Sales Growth % = 0.10  ' Parameter table

' Dynamic forecast
Forecast Sales := 
[Total Sales] * (1 + 'Parameters'[Sales Growth %])

' User selection driven measures
Selected Metric := 
SWITCH(
    TRUE(),
    SELECTEDVALUE('Metric Selection'[Metric]) = "Sales", [Total Sales],
    SELECTEDVALUE('Metric Selection'[Metric]) = "Profit", [Total Profit],
    SELECTEDVALUE('Metric Selection'[Metric]) = "Units", [Total Units],
    BLANK()
)

' Dynamic time period selection
Dynamic Period Sales := 
VAR SelectedPeriod = SELECTEDVALUE('Period Selection'[Period])
RETURN
    SWITCH(
        SelectedPeriod,
        "MTD", [Sales MTD],
        "QTD", [Sales QTD],
        "YTD", [Sales YTD],
        "Full Year", [Total Sales],
        BLANK()
    )
        </pre>

        <h3 class="section-head">7. Performance Optimization</h3>

        <h4 class="subsection-head">7.1 DAX Performance Guidelines</h4>
        <ul style="margin-left: 25px;">
            <li><b>Avoid calculated columns when possible:</b> Use measures for aggregations</li>
            <li><b>Use variables:</b> Improves readability and performance</li>
            <li><b>Minimize iterator functions:</b> SUMX, AVERAGEX, etc., can be slow</li>
            <li><b>Use SUMMARIZE carefully:</b> Can create large intermediate tables</li>
            <li><b>Optimize relationships:</b> Use integer keys, avoid bidirectional filtering</li>
            <li><b>Reduce cardinality:</b> Fewer unique values = better compression</li>
        </ul>

        <h4 class="subsection-head">7.2 Using Performance Analyzer</h4>
        <pre>
' Steps to analyze DAX performance:
' 1. Power Pivot → Manage → Performance Analyzer
' 2. Start recording
' 3. Interact with PivotTable
' 4. Stop recording
' 5. Analyze query plans and timings

' Common performance issues:
' 1. Many-to-many relationships
' 2. Complex calculated columns
' 3. Excessive use of FILTER()
' 4. Lack of proper indexing
' 5. Cross-filtering direction issues

' Optimization techniques:
' 1. Use CALCULATE instead of FILTER when possible
' 2. Pre-calculate values in Power Query
' 3. Use integer keys for relationships
' 4. Disable automatic relationship detection
' 5. Use calculated tables for static aggregations
        </pre>

        <h3 class="section-head">8. Business Intelligence Applications</h3>

        <h4 class="subsection-head">8.1 Complete Sales Dashboard</h4>
        <pre>
' KPI Measures
Total Sales := SUM(Sales[Amount])
Total Profit := SUM(Sales[Profit])
Total Units := SUM(Sales[Quantity])
Average Order Value := DIVIDE([Total Sales], DISTINCTCOUNT(Sales[OrderID]))

' Time Intelligence
Sales YoY Growth := 
VAR CurrentSales = [Total Sales]
VAR PreviousSales = 
    CALCULATE(
        [Total Sales],
        SAMEPERIODLASTYEAR(Calendar[Date])
    )
RETURN
    DIVIDE(CurrentSales - PreviousSales, PreviousSales)

' Product Performance
Top Product Contribution := 
VAR TopProductSales = 
    CALCULATE(
        [Total Sales],
        TOPN(1, VALUES(Product[ProductName]), [Total Sales])
    )
RETURN
    DIVIDE(TopProductSales, [Total Sales])

' Customer Analysis
Customer Retention Rate := 
VAR ReturningCustomers = 
    CALCULATE(
        DISTINCTCOUNT(Sales[CustomerID]),
        FILTER(
            Sales,
            Sales[OrderDate] >= TODAY() - 365 &&
            Sales[OrderDate] < TODAY() - 180
        )
    )
VAR ActiveCustomers = 
    CALCULATE(
        DISTINCTCOUNT(Sales[CustomerID]),
        Sales[OrderDate] >= TODAY() - 180
    )
RETURN
    DIVIDE(ReturningCustomers, ActiveCustomers)

' Regional Analysis
Regional Market Share := 
DIVIDE(
    [Total Sales],
    CALCULATE([Total Sales], ALL(Region))
)
        </pre>

        <h3 class="section-head">9. Integration with Excel</h3>

        <h4 class="subsection-head">9.1 CUBE Functions</h4>
        <pre>
' CUBE functions for dynamic reports
' CUBEVALUE: Returns aggregated value
' CUBEMEMBER: Returns member from hierarchy
' CUBESET: Defines set of members
' CUBERANKEDMEMBER: Returns specific member from set

' Example: Dynamic dashboard
=CUBEVALUE(
    "ThisWorkbookDataModel",
    CUBEMEMBER("ThisWorkbookDataModel", "[Measures].[Total Sales]"),
    CUBEMEMBER("ThisWorkbookDataModel", "[Region].[North]"),
    CUBEMEMBER("ThisWorkbookDataModel", "[Product].[Category].[Electronics]")
)

' Dynamic KPI dashboard
=LET(
    selected_region, CUBEMEMBER("ThisWorkbookDataModel", 
        "[Region].[" & B2 & "]"),
    CUBEVALUE("ThisWorkbookDataModel", 
        "[Measures].[Total Sales]",
        selected_region
    )
)
        </pre>

        <h3 class="section-head">10. Best Practices</h3>
        <ul style="margin-left: 25px;">
            <li>Always create a proper date table for time intelligence</li>
            <li>Use star schema design for optimal performance</li>
            <li>Create explicit measures instead of implicit measures in PivotTables</li>
            <li>Use variables for complex calculations</li>
            <li>Test DAX formulas in DAX Studio for performance</li>
            <li>Document measures with descriptions</li>
            <li>Use calculation groups for dynamic formatting</li>
            <li>Implement row-level security for sensitive data</li>
        </ul>

        <div class="pro-note">
            <b><i class="fas fa-tools"></i> Pro Tip:</b> The real power of DAX comes from understanding filter context. Always ask: "What filters are currently applied?" when debugging DAX formulas.
        </div>

        <button class="btn-premium" onclick="completeModule()">
            <i class="fas fa-lock-open"></i> Unlock Module 05: Financial Modeling
        </button>
    `
},
{
    title: "Module 05: Advanced Financial Modeling",
    desc: "DCF, M&A, LBO Models & Financial Statement Analysis",
    content: `
        <span class="module-tag"><i class="fas fa-chart-line"></i> Finance</span>
        <h2 class="mod-title">Discounted Cash Flow (DCF), M&A, LBO Models & Financial Statement Analysis</h2>

        <p class="body-text">
            This module transforms you into a financial modeling expert. You'll build sophisticated models used by 
            investment banks, private equity firms, and corporate finance teams. We cover valuation techniques, 
            merger modeling, leveraged buyouts, and advanced financial analysis - all implemented in Excel.
        </p>

        <div class="pro-note">
            <b><i class="fas fa-lightbulb"></i> Pro Tip:</b> A good financial model is not just accurate - it's transparent, flexible, and clearly communicates assumptions and results.
        </div>

        <h3 class="section-head">1. Financial Modeling Best Practices</h3>
        <p class="body-text">
            Professional financial models follow strict conventions for reliability and maintainability:
        </p>

        <h4 class="subsection-head">1.1 Model Structure & Design</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Section</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Purpose</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Best Practices</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Cover Page</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Model overview & disclaimer</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Include version, author, date, assumptions summary</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Assumptions</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Input drivers & scenarios</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Clearly labeled, grouped logically, all inputs blue font</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Income Statement</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Revenue to net income</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Follow GAAP/IFRS, show margins, include checks</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Balance Sheet</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Assets = Liabilities + Equity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Must balance, include working capital schedule</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Cash Flow</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Operating, investing, financing</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Reconcile to balance sheet, show sources & uses</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Supporting Schedules</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Detailed calculations</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Depreciation, debt, equity, working capital</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">1.2 Excel Formatting Standards</h4>
        <pre>
' Professional model formatting
' Input cells: Blue font, light blue fill
' Formulas: Black font, no fill
' Links to other sheets: Green font
' Hardcodes: Red font (avoid when possible)

' Cell styles setup
Sub ApplyFinancialModelFormatting()
    ' Input cells
    With Selection.Font
        .Color = RGB(0, 0, 255)  ' Blue
        .Bold = True
    End With
    Selection.Interior.Color = RGB(217, 225, 242)  ' Light blue
    
    ' Formula cells
    With Selection.Font
        .Color = RGB(0, 0, 0)  ' Black
        .Bold = False
    End With
    Selection.Interior.ColorIndex = xlNone
    
    ' Link cells
    With Selection.Font
        .Color = RGB(0, 176, 80)  ' Green
        .Bold = True
    End With
End Sub

' Named ranges for key inputs
' Alt + M + N + D: Define Name
' Revenue_Growth, COGS_Margin, Tax_Rate, etc.
        </pre>

        <h3 class="section-head">2. Three Statement Financial Model</h3>

        <h4 class="subsection-head">2.1 Integrated Financial Statements</h4>
        <pre>
' Income Statement Structure
Revenue := Units_Sold * Average_Price
COGS := Revenue * COGS_Margin
Gross_Profit := Revenue - COGS
Operating_Expenses := Fixed_Costs + (Revenue * Variable_Cost_Rate)
EBITDA := Gross_Profit - Operating_Expenses
Depreciation := PPELastYear * Depreciation_Rate
EBIT := EBITDA - Depreciation
Interest_Expense := Debt_Balance * Interest_Rate
EBT := EBIT - Interest_Expense
Taxes := EBT * Tax_Rate
Net_Income := EBT - Taxes

' Balance Sheet Integration
Cash := Previous_Cash + Cash_Flow_from_Operations
Accounts_Receivable := Revenue * Days_Sales_Outstanding / 365
Inventory := COGS * Days_Inventory_Outstanding / 365
PPE := Previous_PPE + Capex - Depreciation
Total_Assets := Cash + AR + Inventory + PPE

Accounts_Payable := COGS * Days_Payables_Outstanding / 365
Debt := Previous_Debt + New_Debt_Issued - Debt_Repayment
Equity := Previous_Equity + Net_Income - Dividends
Total_Liabilities_and_Equity := AP + Debt + Equity

' Balance check
Balance_Check := Total_Assets - Total_Liabilities_and_Equity
' Should always be zero
        </pre>

        <h4 class="subsection-head">2.2 Cash Flow Statement Reconciliation</h4>
        <pre>
' Operating Cash Flow
Net_Income := From_Income_Statement
Depreciation := Add_Back_Non_Cash_Expense
Change_in_Working_Capital := 
    (Previous_AR - Current_AR) +
    (Previous_Inventory - Current_Inventory) +
    (Current_AP - Previous_AP)
Cash_from_Operations := Net_Income + Depreciation + Change_in_WC

' Investing Cash Flow
Capital_Expenditures := -Capex_Amount
Cash_from_Investing := Capital_Expenditures

' Financing Cash Flow
Debt_Issued := New_Debt
Debt_Repaid := -Principal_Payments
Dividends_Paid := -Dividend_Amount
Cash_from_Financing := Debt_Issued + Debt_Repaid + Dividends_Paid

' Net Cash Flow
Net_Cash_Flow := Cash_from_Operations + Cash_from_Investing + Cash_from_Financing
Ending_Cash := Beginning_Cash + Net_Cash_Flow

' Reconciliation to Balance Sheet
Cash_Reconciliation := Ending_Cash - Balance_Sheet_Cash
' Should be zero
        </pre>

        <h3 class="section-head">3. Discounted Cash Flow (DCF) Valuation</h3>

        <h4 class="subsection-head">3.1 DCF Methodology</h4>
        <pre>
' Step 1: Forecast Free Cash Flows
EBIT := From_Income_Statement
Taxes := EBIT * Tax_Rate
NOPAT := EBIT - Taxes
Depreciation := Add_Back
Capital_Expenditures := -Capex
Change_in_Working_Capital := -Increase_in_WC
Free_Cash_Flow_to_Firm := NOPAT + Depreciation - Capex - Change_in_WC

' Step 2: Calculate Terminal Value
' Perpetuity Growth Method
Terminal_Growth_Rate := 2.5%  ' Long-term GDP growth
Final_Year_FCF := FCF_Year_5
Terminal_Value := Final_Year_FCF * (1 + Terminal_Growth_Rate) / 
                  (WACC - Terminal_Growth_Rate)

' Step 3: Calculate Weighted Average Cost of Capital (WACC)
Cost_of_Equity := Risk_Free_Rate + Beta * Market_Risk_Premium
Cost_of_Debt := Interest_Rate * (1 - Tax_Rate)
WACC := (Equity/Total_Capital) * Cost_of_Equity + 
        (Debt/Total_Capital) * Cost_of_Debt

' Step 4: Discount Cash Flows
Present_Value_FCF := 
    FCF_Year_1 / (1 + WACC)^1 +
    FCF_Year_2 / (1 + WACC)^2 +
    FCF_Year_3 / (1 + WACC)^3 +
    FCF_Year_4 / (1 + WACC)^4 +
    FCF_Year_5 / (1 + WACC)^5

Present_Value_Terminal := Terminal_Value / (1 + WACC)^5

' Step 5: Calculate Enterprise Value
Enterprise_Value := Present_Value_FCF + Present_Value_Terminal

' Step 6: Calculate Equity Value
Equity_Value := Enterprise_Value - Net_Debt + Cash

' Step 7: Calculate Share Price
Share_Price := Equity_Value / Shares_Outstanding
        </pre>

        <h4 class="subsection-head">3.2 Sensitivity Analysis</h4>
        <pre>
' Two-way data table for WACC and growth rate
' Set up input ranges
WACC_Range := {8.0%, 9.0%, 10.0%, 11.0%, 12.0%}
Growth_Range := {2.0%, 2.5%, 3.0%, 3.5%, 4.0%}

' Create data table
=TABLE(WACC_Cell, Growth_Cell)

' Tornado chart for key drivers
Drivers := {
    "Revenue Growth",
    "EBITDA Margin", 
    "WACC",
    "Terminal Growth",
    "Capex % of Revenue"
}

' Impact on valuation
=LET(
    base_value, Base_Equity_Value,
    sensitivity, 0.10,  ' 10% change
    driver_impact, {
        Revenue_Growth_Impact,
        EBITDA_Margin_Impact,
        WACC_Impact,
        Terminal_Growth_Impact,
        Capex_Impact
    },
    HSTACK(Drivers, driver_impact)
)

' Monte Carlo simulation for valuation
Sub RunMonteCarlo()
    Dim i As Long
    Dim iterations As Long: iterations = 10000
    Dim results() As Double
    ReDim results(1 To iterations)
    
    For i = 1 To iterations
        ' Random inputs based on distributions
        Revenue_Growth = Application.NormInv(Rnd(), 0.05, 0.02)
        EBITDA_Margin = Application.NormInv(Rnd(), 0.15, 0.03)
        WACC = Application.NormInv(Rnd(), 0.10, 0.01)
        
        ' Calculate valuation
        results(i) = CalculateValuation(Revenue_Growth, EBITDA_Margin, WACC)
    Next i
    
    ' Analyze results
    Mean_Value = Application.Average(results)
    Std_Dev = Application.StDev(results)
    Percentile_5 = Application.Percentile(results, 0.05)
    Percentile_95 = Application.Percentile(results, 0.95)
End Sub
        </pre>

        <h3 class="section-head">4. Merger & Acquisition (M&A) Modeling</h3>

        <h4 class="subsection-head">4.1 Accretion/Dilution Analysis</h4>
        <pre>
' Step 1: Project combined financials
Combined_Revenue := Acquirer_Revenue + Target_Revenue - Revenue_Synergies
Combined_EBITDA := Acquirer_EBITDA + Target_EBITDA + Cost_Synergies

' Step 2: Deal financing
Purchase_Price := Target_Shares * Offer_Price
Cash_Financing := Min(Purchase_Price, Available_Cash)
Debt_Financing := Purchase_Price - Cash_Financing
New_Shares_Issued := (Purchase_Price - Cash_Financing - Debt_Financing) / Acquirer_Share_Price

' Step 3: Combined capitalization
New_Debt := Acquirer_Debt + Target_Debt + Debt_Financing
New_Shares_Outstanding := Acquirer_Shares + New_Shares_Issued

' Step 4: Calculate accretion/dilution
Acquirer_EPS := Acquirer_Net_Income / Acquirer_Shares
Combined_EPS := (Acquirer_Net_Income + Target_Net_Income + Synergy_After_Tax) / New_Shares_Outstanding
Accretion_Dilution := (Combined_EPS / Acquirer_EPS) - 1

' Step 5: Credit metrics
Pro_Forma_Net_Debt_to_EBITDA := New_Debt / Combined_EBITDA
Interest_Coverage_Ratio := Combined_EBIT / (Acquirer_Interest + New_Debt_Interest)
        </pre>

        <h4 class="subsection-head">4.2 Merger Model Structure</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Section</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Contents</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Key Outputs</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Transaction Assumptions</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Offer price, payment mix, synergies</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Purchase price, financing structure</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Acquirer Model</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Standalone financial projections</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">EPS, credit metrics, valuation</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Target Model</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Standalone financial projections</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Implied valuation, financial metrics</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Combined Model</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Pro forma financial statements</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Accretion/dilution, synergy realization</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Returns Analysis</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">IRR, MOIC, sensitivity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Investment returns under various scenarios</td></tr>
                </tbody>
            </table>
        </div>

        <h3 class="section-head">5. Leveraged Buyout (LBO) Modeling</h3>

        <h4 class="subsection-head">5.1 LBO Mechanics</h4>
        <pre>
' Step 1: Sources & Uses
Sources := {
    "Senior Debt",
    "Subordinated Debt",
    "Sponsor Equity",
    "Rollover Equity"
}

Uses := {
    "Purchase Equity",
    "Repay Existing Debt",
    "Transaction Fees",
    "Financing Fees"
}

' Step 2: Operating model
Revenue_Growth := Based_on_Industry_and_Company
EBITDA_Margin := Historical_with_Improvements
Capex := Maintenance_Capex + Growth_Capex
Working_Capital := Revenue * WC_Days / 365

' Step 3: Debt schedule
Senior_Debt_Amortization := 
    PMT(Senior_Rate/12, Senior_Term*12, -Senior_Amount)
Subordinated_Debt_Amortization := Bullet_at_Maturity
Cash_Sweep := Excess_Cash_Flow * Sweep_Percentage

' Step 4: Exit valuation
Exit_Year := 5
Exit_EBITDA := Year_5_EBITDA
Exit_Multiple := Entry_Multiple * (1 + Multiple_Expansion)
Exit_Enterprise_Value := Exit_EBITDA * Exit_Multiple
Exit_Equity_Value := Exit_Enterprise_Value - Exit_Debt

' Step 5: Returns calculation
MOIC := Exit_Equity_Value / Sponsor_Equity
IRR := RATE(Holding_Period, 0, -Sponsor_Equity, Exit_Equity_Value)
        </pre>

        <h4 class="subsection-head">5.2 Credit Agreement Covenants</h4>
        <pre>
' Debt covenants monitoring
' Senior Secured Leverage Ratio
Senior_Leverage_Ratio := Senior_Debt / EBITDA
Covenant_Limit := 4.0  ' Example: Maximum 4.0x

' Total Leverage Ratio
Total_Leverage_Ratio := Total_Debt / EBITDA
Covenant_Limit := 6.0  ' Example: Maximum 6.0x

' Interest Coverage Ratio
Interest_Coverage := EBITDA / Interest_Expense
Covenant_Minimum := 2.0  ' Example: Minimum 2.0x

' Fixed Charge Coverage Ratio
Fixed_Charge_Coverage := 
    (EBITDA - Capex) / (Interest_Expense + Principal_Amortization)
Covenant_Minimum := 1.2  ' Example: Minimum 1.2x

' Covenant compliance check
Compliance_Check := IF(Total_Leverage_Ratio <= 6.0, "Compliant", "Breach")
        </pre>

        <h3 class="section-head">6. Financial Ratio Analysis</h3>

        <h4 class="subsection-head">6.1 Key Financial Ratios</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Category</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Ratio</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Formula</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Interpretation</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;" rowspan="3">Profitability</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Gross Margin</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Gross Profit / Revenue</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Production efficiency</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">EBITDA Margin</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">EBITDA / Revenue</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Operating profitability</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Return on Equity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Net Income / Equity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Shareholder returns</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;" rowspan="3">Liquidity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Current Ratio</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Current Assets / Current Liabilities</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Short-term solvency</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Quick Ratio</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">(Cash + AR) / Current Liabilities</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Immediate liquidity</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Cash Conversion Cycle</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">DSO + DIO - DPO</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Working capital efficiency</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;" rowspan="3">Leverage</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Debt/EBITDA</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Total Debt / EBITDA</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Debt servicing capacity</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Debt/Equity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Total Debt / Total Equity</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Capital structure</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Interest Coverage</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">EBIT / Interest Expense</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Interest payment ability</td></tr>
                </tbody>
            </table>
        </div>

        <h3 class="section-head">7. Scenario & Sensitivity Analysis</h3>

        <h4 class="subsection-head">7.1 Building Scenario Manager</h4>
        <pre>
' Define scenarios
Scenarios := {
    "Base Case",
    "Optimistic",
    "Pessimistic",
    "Stress Test"
}

' Key drivers for each scenario
Scenario_Table := {
    {"Scenario", "Revenue Growth", "EBITDA Margin", "WACC"},
    {"Base", 5.0%, 15.0%, 10.0%},
    {"Optimistic", 8.0%, 18.0%, 9.0%},
    {"Pessimistic", 2.0%, 12.0%, 11.0%},
    {"Stress", -5.0%, 8.0%, 13.0%}
}

' Dynamic scenario selection
Selected_Scenario := INDEX(Scenario_Table, MATCH(Scenario_Name, Scenario_Table[Scenario], 0), 0)
Revenue_Growth := INDEX(Selected_Scenario, MATCH("Revenue Growth", Scenario_Table[#Headers], 0))
EBITDA_Margin := INDEX(Selected_Scenario, MATCH("EBITDA Margin", Scenario_Table[#Headers], 0))
WACC := INDEX(Selected_Scenario, MATCH("WACC", Scenario_Table[#Headers], 0))

' Scenario output summary
Scenario_Summary := 
LET(
    scenarios, Scenario_Table[Scenario],
    valuations, BYROW(scenarios, LAMBDA(s, CalculateValuationForScenario(s))),
    HSTACK(scenarios, valuations)
)
        </pre>

        <h4 class="subsection-head">7.2 Advanced Sensitivity Tools</h4>
        <pre>
' Spider chart for multiple variables
Sensitivity_Variables := {
    "Revenue Growth",
    "COGS Margin",
    "Operating Expenses",
    "WACC",
    "Terminal Growth"
}

Sensitivity_Range := {-20%, -10%, 0%, 10%, 20%}

' Impact matrix
Sensitivity_Matrix := 
MAKEARRAY(
    ROWS(Sensitivity_Variables),
    COLUMNS(Sensitivity_Range),
    LAMBDA(r, c,
        LET(
            variable, INDEX(Sensitivity_Variables, r),
            change, INDEX(Sensitivity_Range, c),
            CalculateValuationImpact(variable, change)
        )
    )
)

' Tornado chart data prep
Tornado_Data := 
LET(
    base_value, Base_Valuation,
    impacts, {
        CalculateValuationImpact("Revenue Growth", 0.10),
        CalculateValuationImpact("EBITDA Margin", 0.03),
        CalculateValuationImpact("WACC", 0.01),
        CalculateValuationImpact("Terminal Growth", 0.005)
    },
    differences, impacts - base_value,
    SORT(HSTACK(Sensitivity_Variables, differences), 2, -1)
)
        </pre>

        <h3 class="section-head">8. Model Auditing & Error Checking</h3>

        <h4 class="subsection-head">8.1 Comprehensive Error Checks</h4>
        <pre>
' Balance sheet check
Balance_Sheet_Check := 
IF(ABS(Total_Assets - Total_Liabilities_and_Equity) < 0.01, 
   "✓ Balanced", 
   "✗ Out of balance by " & TEXT(Total_Assets - Total_Liabilities_and_Equity, "#,##0.00"))

' Cash flow reconciliation
Cash_Flow_Check := 
IF(ABS(Net_Cash_Flow - (Ending_Cash - Beginning_Cash)) < 0.01,
   "✓ Reconciled",
   "✗ Mismatch")

' Income statement margin validation
Margin_Check := 
IF(AND(Gross_Margin >= 0, Gross_Margin <= 1,
       EBITDA_Margin >= 0, EBITDA_Margin <= 1,
       Net_Margin >= 0, Net_Margin <= 1),
   "✓ Margins valid",
   "✗ Invalid margins")

' Growth rate sanity checks
Growth_Check := 
IF(AND(Revenue_Growth >= -0.5, Revenue_Growth <= 2.0,
       EBITDA_Growth >= -0.5, EBITDA_Growth <= 2.0),
   "✓ Growth rates reasonable",
   "✗ Unrealistic growth")

' Debt covenant checks
Covenant_Check := 
IF(AND(Total_Leverage_Ratio <= 6.0,
       Interest_Coverage >= 2.0),
   "✓ Covenants met",
   "✗ Covenant breach")

' Summary dashboard of all checks
Model_Health := 
IF(COUNTIF(Checks_Range, "*✗*") = 0,
   "Model OK",
   "Issues: " & COUNTIF(Checks_Range, "*✗*"))
        </pre>

        <h3 class="section-head">9. Real-World Case Study</h3>

        <h4 class="subsection-head">9.1 Technology Company Valuation</h4>
        <pre>
' Technology DCF specific considerations
' Revenue drivers: User growth, ARPU, market share
' Margins: Scale economies, R&D amortization
' Capex: Technology infrastructure, development costs
' Working capital: Typically negative (subscription model)

' SaaS company metrics
Monthly_Recurring_Revenue := Paying_Users * Average_Revenue_per_User
Annual_Recurring_Revenue := MRR * 12
Gross_Churn := Lost_Customers / Beginning_Customers
Net_Revenue_Retention := (Beginning_ARPU * (1 - Gross_Churn) + Expansion) / Beginning_ARPU
CAC := Sales_and_Marketing_Expense / New_Customers
LTV := Average_ARPU * Gross_Margin / Churn_Rate
LTV_to_CAC_Ratio := LTV / CAC

' Technology DCF adjustments
Stock_Based_Compensation := Add_Back_to_NOPAT
R&D_Capitalization := Treat_as_Intangible_Asset_Amortization
Deferred_Revenue := Liability_on_Balance_Sheet
Customer_Acquisition_Costs := Capitalize_and_Amortize

' Exit multiple considerations
Comparable_Companies := FILTER(Public_Comps, Sector = "Technology")
Implied_Multiples := 
    AVERAGEIFS(
        Public_Comps[EV/Revenue],
        Public_Comps[Growth_Rate], ">" & Our_Growth - 0.05,
        Public_Comps[Growth_Rate], "<" & Our_Growth + 0.05,
        Public_Comps[Profit_Margin], ">" & Our_Margin - 0.05
    )
        </pre>

        <h3 class="section-head">10. Best Practices Summary</h3>
        <ul style="margin-left: 25px;">
            <li>Always start with a clear model structure and input sheet</li>
            <li>Use consistent formatting and color coding</li>
            <li>Build in error checks and balancing mechanisms</li>
            <li>Document all assumptions clearly</li>
            <li>Use named ranges for key inputs</li>
            <li>Build flexible scenario management</li>
            <li>Include sensitivity analysis for key drivers</li>
            <li>Validate outputs against historicals and comparables</li>
            <li>Keep models as simple as possible while meeting requirements</li>
            <li>Test models with extreme inputs to ensure robustness</li>
        </ul>

        <div class="pro-note">
            <b><i class="fas fa-tools"></i> Pro Tip:</b> The most valuable part of a financial model is not the output number, but the understanding of value drivers and risks it provides. Focus on insights, not just calculations.
        </div>

        <button class="btn-premium" onclick="completeModule()">
            <i class="fas fa-lock-open"></i> Unlock Module 06: Dashboard & Visualization
        </button>
    `
},

{
    title: "Module 06: Statistical Analysis in Excel",
    desc: "Regression, Forecasting, Hypothesis Testing & Monte Carlo",
    content: `
        <span class="module-tag"><i class="fas fa-chart-area"></i> Statistics</span>
        <h2 class="mod-title">Regression Analysis, Forecasting, Hypothesis Testing & Monte Carlo Simulation</h2>

        <p class="body-text">
            Excel is a powerful statistical tool when you know how to leverage its advanced capabilities. 
            This module covers professional statistical analysis techniques including regression modeling, 
            time series forecasting, hypothesis testing, and simulation methods used in data science and 
            business analytics.
        </p>

        <div class="pro-note">
            <b><i class="fas fa-lightbulb"></i> Pro Tip:</b> Excel's Analysis ToolPak and modern dynamic array functions make sophisticated statistical analysis accessible without specialized software.
        </div>

        <h3 class="section-head">1. Statistical Foundations in Excel</h3>
        <p class="body-text">
            Before diving into advanced techniques, ensure you understand Excel's statistical capabilities:
        </p>

        <h4 class="subsection-head">1.1 Enabling Analysis ToolPak</h4>
        <pre>
' Enable Analysis ToolPak
' File → Options → Add-ins
' Manage: Excel Add-ins → Go
' Check: Analysis ToolPak

' Statistical functions overview
' Descriptive: AVERAGE, MEDIAN, MODE, STDEV, VAR
' Inferential: T.TEST, F.TEST, CHISQ.TEST
' Regression: LINEST, LOGEST, TREND, FORECAST
' Probability: NORM.DIST, BINOM.DIST, POISSON.DIST
' Random: RAND, RANDBETWEEN, NORM.INV

' Data Analysis ToolPak procedures
' Descriptive Statistics
' Histogram
' Regression
' t-Tests
' ANOVA
' Correlation
' Covariance
' Moving Average
' Random Number Generation
' Sampling
        </pre>

        <h4 class="subsection-head">1.2 Data Preparation for Analysis</h4>
        <pre>
' Clean data for statistical analysis
Sub PrepareDataForAnalysis()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets("Data")
    
    ' Remove duplicates
    ws.Range("A1").CurrentRegion.RemoveDuplicates _
        Columns:=Array(1, 2, 3), Header:=xlYes
    
    ' Handle missing values
    Dim rng As Range
    Set rng = ws.UsedRange
    
    For Each cell In rng
        If IsError(cell.Value) Then
            cell.Value = ""
        End If
    Next cell
    
    ' Remove outliers using IQR method
    RemoveOutliers ws.Range("C2:C1000")
    
    ' Normalize data if needed
    If NeedsNormalization(ws.Range("D2:D1000")) Then
        NormalizeData ws.Range("D2:D1000")
    End If
    
    ' Create analysis-ready dataset
    CreateAnalysisDataset ws
End Sub

' Identify and handle outliers
Sub RemoveOutliers(rng As Range)
    Dim data As Variant
    data = rng.Value
    
    ' Calculate quartiles
    Dim q1 As Double, q3 As Double
    q1 = Application.Quartile(data, 1)
    q3 = Application.Quartile(data, 3)
    
    Dim iqr As Double
    iqr = q3 - q1
    
    Dim lowerBound As Double, upperBound As Double
    lowerBound = q1 - 1.5 * iqr
    upperBound = q3 + 1.5 * iqr
    
    ' Flag outliers
    Dim i As Long
    For i = 1 To UBound(data, 1)
        If data(i, 1) < lowerBound Or data(i, 1) > upperBound Then
            rng.Cells(i, 1).Interior.Color = RGB(255, 200, 200)
            ' Option: Replace with NA or median
            ' rng.Cells(i, 1).Value = Application.Median(data)
        End If
    Next i
End Sub
        </pre>

        <h3 class="section-head">2. Descriptive Statistics & Data Exploration</h3>

        <h4 class="subsection-head">2.1 Comprehensive Descriptive Analysis</h4>
        <pre>
' Complete descriptive statistics report
Function GetDescriptiveStats(rng As Range) As Variant
    Dim data As Variant
    data = rng.Value
    
    Dim stats(1 To 15, 1 To 2) As Variant
    
    stats(1, 1) = "Count"
    stats(1, 2) = Application.Count(data)
    
    stats(2, 1) = "Mean"
    stats(2, 2) = Application.Average(data)
    
    stats(3, 1) = "Median"
    stats(3, 2) = Application.Median(data)
    
    stats(4, 1) = "Mode"
    stats(4, 2) = Application.Mode(data)
    
    stats(5, 1) = "Standard Deviation"
    stats(5, 2) = Application.StDev(data)
    
    stats(6, 1) = "Variance"
    stats(6, 2) = Application.Var(data)
    
    stats(7, 1) = "Minimum"
    stats(7, 2) = Application.Min(data)
    
    stats(8, 1) = "Maximum"
    stats(8, 2) = Application.Max(data)
    
    stats(9, 1) = "Range"
    stats(9, 2) = stats(8, 2) - stats(7, 2)
    
    stats(10, 1) = "Q1 (25th percentile)"
    stats(10, 2) = Application.Quartile(data, 1)
    
    stats(11, 1) = "Q3 (75th percentile)"
    stats(11, 2) = Application.Quartile(data, 3)
    
    stats(12, 1) = "IQR"
    stats(12, 2) = stats(11, 2) - stats(10, 2)
    
    stats(13, 1) = "Skewness"
    stats(13, 2) = Application.Skew(data)
    
    stats(14, 1) = "Kurtosis"
    stats(14, 2) = Application.Kurt(data)
    
    stats(15, 1) = "Coefficient of Variation"
    stats(15, 2) = stats(5, 2) / stats(2, 2)
    
    GetDescriptiveStats = stats
End Function

' Dynamic array version (Excel 365)
=LET(
    data, A2:A1000,
    HSTACK(
        {"Statistic", "Value"},
        {"Count", COUNT(data)},
        {"Mean", AVERAGE(data)},
        {"Median", MEDIAN(data)},
        {"Std Dev", STDEV(data)},
        {"Min", MIN(data)},
        {"Max", MAX(data)},
        {"Q1", QUARTILE(data, 1)},
        {"Q3", QUARTILE(data, 3)},
        {"IQR", QUARTILE(data, 3) - QUARTILE(data, 1)},
        {"Skewness", SKEW(data)},
        {"Kurtosis", KURT(data)}
    )
)
        </pre>

        <h4 class="subsection-head">2.2 Data Visualization for Exploration</h4>
        <pre>
' Create exploratory data analysis dashboard
Sub CreateEDAReport()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets.Add
    ws.Name = "EDA_Report"
    
    ' Histogram with dynamic bins
    CreateHistogram ws.Range("A2:A1000"), ws.Range("C2")
    
    ' Box plot using sparklines
    CreateBoxPlot ws.Range("A2:A1000"), ws.Range("E2")
    
    ' Q-Q plot for normality check
    CreateQQPlot ws.Range("A2:A1000"), ws.Range("G2")
    
    ' Scatter plot matrix for multivariate data
    CreateScatterMatrix ws.Range("A2:D1000"), ws.Range("I2")
    
    ' Correlation heatmap
    CreateCorrelationHeatmap ws.Range("A2:D1000"), ws.Range("M2")
End Sub

' Dynamic histogram with optimal bin size
Sub CreateHistogram(dataRange As Range, outputCell As Range)
    ' Freedman-Diaconis rule for optimal bins
    Dim n As Long: n = Application.Count(dataRange)
    Dim iqr As Double: iqr = Application.Quartile(dataRange, 3) - _
                             Application.Quartile(dataRange, 1)
    Dim binWidth As Double: binWidth = 2 * iqr / (n ^ (1 / 3))
    
    Dim minVal As Double: minVal = Application.Min(dataRange)
    Dim maxVal As Double: maxVal = Application.Max(dataRange)
    Dim numBins As Long: numBins = Application.RoundUp((maxVal - minVal) / binWidth, 0)
    
    ' Create bins
    Dim bins() As Double
    ReDim bins(1 To numBins + 1)
    
    Dim i As Long
    For i = 1 To numBins + 1
        bins(i) = minVal + (i - 1) * binWidth
    Next i
    
    ' Create histogram using FREQUENCY
    Dim binRange As Range
    Set binRange = outputCell.Resize(numBins + 1, 1)
    binRange.Value = Application.Transpose(bins)
    
    Dim freqRange As Range
    Set freqRange = outputCell.Offset(0, 1).Resize(numBins + 1, 1)
    freqRange.FormulaArray = "=FREQUENCY(" & dataRange.Address & _
                             "," & binRange.Address & ")"
    
    ' Create chart
    Dim chartObj As ChartObject
    Set chartObj = ws.ChartObjects.Add(Left:=outputCell.Offset(0, 3).Left, _
                                       Top:=outputCell.Top, _
                                       Width:=400, Height:=300)
    
    With chartObj.Chart
        .ChartType = xlColumnClustered
        .SetSourceData Source:=Union(binRange, freqRange)
        .HasTitle = True
        .ChartTitle.Text = "Histogram"
        .Axes(xlCategory).HasTitle = True
        .Axes(xlCategory).AxisTitle.Text = "Value"
        .Axes(xlValue).HasTitle = True
        .Axes(xlValue).AxisTitle.Text = "Frequency"
    End With
End Sub
        </pre>

        <h3 class="section-head">3. Hypothesis Testing</h3>

        <h4 class="subsection-head">3.1 Common Statistical Tests</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Test</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Excel Function</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Use Case</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Interpretation</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">t-Test (One Sample)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">T.TEST(array, x, tails, type)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Compare sample mean to known value</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">p < 0.05: Mean differs significantly</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">t-Test (Two Sample)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">T.TEST(array1, array2, tails, type)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Compare means of two groups</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">p < 0.05: Group means differ</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Paired t-Test</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">T.TEST(before, after, 2, 1)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Before/after measurements</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">p < 0.05: Significant change</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">ANOVA</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Data Analysis → ANOVA</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Compare means of 3+ groups</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">F-significance < 0.05: Some means differ</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Chi-Square Test</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">CHISQ.TEST(actual, expected)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Categorical data independence</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">p < 0.05: Variables not independent</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">3.2 A/B Testing Framework</h4>
        <pre>
' Complete A/B testing analysis
Function RunABTest(controlData As Range, variantData As Range, _
                   alpha As Double, testType As String) As Variant
    
    Dim result(1 To 6, 1 To 2) As Variant
    
    ' Basic statistics
    result(1, 1) = "Control Mean"
    result(1, 2) = Application.Average(controlData)
    
    result(2, 1) = "Variant Mean"
    result(2, 2) = Application.Average(variantData)
    
    result(3, 1) = "Difference"
    result(3, 2) = result(2, 2) - result(1, 2)
    
    result(4, 1) = "Percent Change"
    result(4, 2) = result(3, 2) / result(1, 2)
    
    ' Statistical test
    Dim pValue As Double
    Dim testStatistic As Double
    
    Select Case UCase(testType)
        Case "T"
            ' Two-sample t-test
            pValue = Application.TTest(controlData, variantData, 2, 3)
            testStatistic = CalculateTStatistic(controlData, variantData)
            
        Case "PROPORTION"
            ' Proportion test (z-test)
            pValue = ProportionTest(controlData, variantData)
            testStatistic = CalculateZStatistic(controlData, variantData)
            
        Case "NONPARAMETRIC"
            ' Mann-Whitney U test
            pValue = MannWhitneyTest(controlData, variantData)
            testStatistic = CalculateUStatistic(controlData, variantData)
    End Select
    
    result(5, 1) = "p-value"
    result(5, 2) = pValue
    
    result(6, 1) = "Statistically Significant"
    result(6, 2) = IIf(pValue < alpha, "YES", "NO")
    
    RunABTest = result
    
    ' Power analysis
    Dim power As Double
    power = CalculatePower(controlData, variantData, alpha)
    
    ' Confidence interval
    Dim ci() As Double
    ci = CalculateConfidenceInterval(controlData, variantData, 1 - alpha)
    
    ' Create summary report
    CreateABTestReport result, power, ci, alpha
End Function

' Sample size calculator for A/B tests
Function CalculateSampleSize(alpha As Double, power As Double, _
                            effectSize As Double, testType As String) As Long
    
    Dim zAlpha As Double, zBeta As Double
    
    ' Z-scores for alpha and beta
    zAlpha = Application.Norm_S_Inv(1 - alpha / 2)  ' Two-tailed
    zBeta = Application.Norm_S_Inv(power)
    
    Dim n As Double
    
    Select Case UCase(testType)
        Case "PROPORTION"
            ' For proportion tests
            n = ((zAlpha + zBeta) ^ 2 * _
                (0.5 * (1 - 0.5) + 0.5 * (1 - 0.5))) / _
                (effectSize ^ 2)
                
        Case "MEAN"
            ' For mean difference tests
            n = 2 * ((zAlpha + zBeta) ^ 2) / (effectSize ^ 2)
    End Select
    
    CalculateSampleSize = Application.RoundUp(n, 0)
End Function
        </pre>

        <h3 class="section-head">4. Regression Analysis</h3>

        <h4 class="subsection-head">4.1 Linear Regression with LINEST</h4>
        <pre>
' Complete regression analysis using LINEST
Function RunRegression(yRange As Range, xRanges As Range, _
                       includeStats As Boolean) As Variant
    
    ' LINEST returns array:
    ' Row 1: Coefficients (slopes) and intercept
    ' Row 2: Standard errors
    ' Row 3: R-squared and standard error of y estimate
    ' Row 4: F statistic and degrees of freedom
    ' Row 5: Regression and residual sum of squares
    
    Dim regressionOutput As Variant
    regressionOutput = Application.LinEst(yRange, xRanges, True, True)
    
    ' Extract key statistics
    Dim output(1 To 10, 1 To 3) As Variant
    
    ' Coefficients
    Dim numVars As Long: numVars = xRanges.Columns.Count
    Dim i As Long
    
    For i = 0 To numVars
        output(i + 1, 1) = IIf(i = 0, "Intercept", "Variable " & i)
        output(i + 1, 2) = regressionOutput(1, numVars - i + 1)
        output(i + 1, 3) = regressionOutput(2, numVars - i + 1)
    Next i
    
    ' Model statistics
    output(numVars + 2, 1) = "R-squared"
    output(numVars + 2, 2) = regressionOutput(3, 1)
    
    output(numVars + 3, 1) = "Adjusted R-squared"
    output(numVars + 3, 2) = 1 - (1 - regressionOutput(3, 1)) * _
        (yRange.Rows.Count - 1) / (yRange.Rows.Count - numVars - 1)
    
    output(numVars + 4, 1) = "Standard Error"
    output(numVars + 4, 2) = regressionOutput(3, 2)
    
    output(numVars + 5, 1) = "F-statistic"
    output(numVars + 5, 2) = regressionOutput(4, 1)
    
    output(numVars + 6, 1) = "Significance F"
    output(numVars + 6, 2) = Application.FDist(regressionOutput(4, 1), _
                                              numVars, _
                                              yRange.Rows.Count - numVars - 1)
    
    RunRegression = output
    
    ' Calculate predictions and residuals
    CalculatePredictions yRange, xRanges, regressionOutput
    CalculateDiagnostics yRange, xRanges, regressionOutput
End Function

' Multiple regression with variable selection
Function StepwiseRegression(yRange As Range, xRanges As Range, _
                           alphaEnter As Double, alphaRemove As Double) As Variant
    
    Dim variables() As String
    Dim coefficients() As Double
    Dim included() As Boolean
    
    ' Initialize
    ReDim variables(1 To xRanges.Columns.Count)
    ReDim coefficients(1 To xRanges.Columns.Count)
    ReDim included(1 To xRanges.Columns.Count)
    
    For i = 1 To xRanges.Columns.Count
        variables(i) = "X" & i
        included(i) = False
    Next i
    
    Dim currentModel As Variant
    Dim bestModel As Variant
    Dim bestRSquared As Double: bestRSquared = 0
    
    ' Forward selection
    Do
        Dim bestVar As Long: bestVar = 0
        Dim bestPValue As Double: bestPValue = 1
        
        For i = 1 To xRanges.Columns.Count
            If Not included(i) Then
                ' Test adding this variable
                Dim testModel As Variant
                testModel = TestVariableAddition(yRange, xRanges, included, i)
                
                If testModel(1) < bestPValue And testModel(1) < alphaEnter Then
                    bestPValue = testModel(1)
                    bestVar = i
                    currentModel = testModel
                End If
            End If
        Next i
        
        If bestVar > 0 Then
            included(bestVar) = True
            coefficients(bestVar) = currentModel(2)
            
            ' Check R-squared improvement
            If currentModel(3) > bestRSquared Then
                bestRSquared = currentModel(3)
                bestModel = currentModel
            End If
        End If
        
    Loop While bestVar > 0
    
    ' Backward elimination
    Do
        Dim worstVar As Long: worstVar = 0
        Dim worstPValue As Double: worstPValue = 0
        
        For i = 1 To xRanges.Columns.Count
            If included(i) Then
                ' Test removing this variable
                Dim removalTest As Variant
                removalTest = TestVariableRemoval(yRange, xRanges, included, i)
                
                If removalTest(1) > worstPValue And removalTest(1) > alphaRemove Then
                    worstPValue = removalTest(1)
                    worstVar = i
                End If
            End If
        Next i
        
        If worstVar > 0 Then
            included(worstVar) = False
            coefficients(worstVar) = 0
        End If
        
    Loop While worstVar > 0
    
    ' Return final model
    Dim finalVariables() As String
    Dim finalCoefficients() As Double
    Dim count As Long: count = 0
    
    For i = 1 To xRanges.Columns.Count
        If included(i) Then
            count = count + 1
            ReDim Preserve finalVariables(1 To count)
            ReDim Preserve finalCoefficients(1 To count)
            finalVariables(count) = variables(i)
            finalCoefficients(count) = coefficients(i)
        End If
    Next i
    
    StepwiseRegression = Array(finalVariables, finalCoefficients, bestRSquared)
End Function
        </pre>

        <h3 class="section-head">5. Time Series Forecasting</h3>

        <h4 class="subsection-head">5.1 Forecasting Methods in Excel</h4>
        <div style="overflow-x: auto; margin: 20px 0;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f1f5f9;">
                    <tr><th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Method</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Excel Function</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Best For</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e2e8f0;">Seasonality</th></tr>
                </thead>
                <tbody>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Moving Average</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">AVERAGE(OFFSET)</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Smoothing noise</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">No</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Exponential Smoothing</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Data Analysis → Exponential Smoothing</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Recent trends</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">No</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Holt-Winters</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Custom formulas</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Trend + seasonality</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Yes</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">ARIMA</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">LINEST with lags</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Complex patterns</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Optional</td></tr>
                    <tr><td style="padding: 12px; border: 1px solid #e2e8f0;">Regression</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">FORECAST.LINEAR</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">Linear trends</td>
                        <td style="padding: 12px; border: 1px solid #e2e8f0;">No</td></tr>
                </tbody>
            </table>
        </div>

        <h4 class="subsection-head">5.2 Holt-Winters Triple Exponential Smoothing</h4>
        <pre>
' Holt-Winters forecasting implementation
Function HoltWintersForecast(data As Range, _
                            alpha As Double, _
                            beta As Double, _
                            gamma As Double, _
                            seasonLength As Long, _
                            forecastPeriods As Long) As Variant
    
    Dim n As Long: n = data.Rows.Count
    Dim level() As Double, trend() As Double, seasonal() As Double
    ReDim level(1 To n + forecastPeriods)
    ReDim trend(1 To n + forecastPeriods)
    ReDim seasonal(1 To n + forecastPeriods)
    ReDim forecast(1 To n + forecastPeriods, 1 To 2)
    
    ' Initialize
    level(1) = data.Cells(1, 1).Value
    trend(1) = 0
    
    For i = 1 To seasonLength
        seasonal(i) = data.Cells(i, 1).Value / Application.Average( _
            data.Resize(seasonLength, 1))
    Next i
    
    ' Training (smoothing)
    For i = 2 To n
        If i > seasonLength Then
            level(i) = alpha * (data.Cells(i, 1).Value / seasonal(i - seasonLength)) + _
                      (1 - alpha) * (level(i - 1) + trend(i - 1))
            trend(i) = beta * (level(i) - level(i - 1)) + _
                      (1 - beta) * trend(i - 1)
            seasonal(i) = gamma * (data.Cells(i, 1).Value / level(i)) + _
                         (1 - gamma) * seasonal(i - seasonLength)
        Else
            level(i) = alpha * data.Cells(i, 1).Value + _
                      (1 - alpha) * level(i - 1)
            trend(i) = beta * (level(i) - level(i - 1)) + _
                      (1 - beta) * trend(i - 1)
        End If
    Next i
    
    ' Forecasting
    For i = n + 1 To n + forecastPeriods
        Dim h As Long: h = i - n
        level(i) = level(i - 1) + trend(i - 1)
        trend(i) = trend(i - 1)
        
        If i <= seasonLength Then
            seasonal(i) = seasonal(i)
        Else
            seasonal(i) = seasonal(i - seasonLength)
        End If
        
        forecast(h, 1) = i  ' Period
        forecast(h, 2) = (level(i) + h * trend(i)) * seasonal(i)  ' Forecast
    Next i
    
    ' Calculate forecast intervals
    Dim mse As Double: mse = CalculateMSE(data, level, seasonal, seasonLength)
    Dim stdError As Double: stdError = Sqr(mse)
    
    For i = 1 To forecastPeriods
        forecast(i, 3) = forecast(i, 2) - 1.96 * stdError * Sqr(i)  ' Lower bound
        forecast(i, 4) = forecast(i, 2) + 1.96 * stdError * Sqr(i)  ' Upper bound
    Next i
    
    HoltWintersForecast = forecast
    
    ' Optimization of parameters using grid search
    OptimizeHoltWintersParameters data, seasonLength
End Function

' Forecast accuracy metrics
Function CalculateForecastAccuracy(actual As Range, forecast As Range) As Variant
    Dim n As Long: n = actual.Rows.Count
    
    Dim errors() As Double
    ReDim errors(1 To n)
    
    Dim mae As Double, mse As Double, rmse As Double, mape As Double
    Dim sumAbsError As Double, sumSqError As Double, sumPctError As Double
    
    For i = 1 To n
        errors(i) = actual.Cells(i, 1).Value - forecast.Cells(i, 1).Value
        
        sumAbsError = sumAbsError + Abs(errors(i))
        sumSqError = sumSqError + errors(i) ^ 2
        
        If actual.Cells(i, 1).Value <> 0 Then
            sumPctError = sumPctError + Abs(errors(i) / actual.Cells(i, 1).Value)
        End If
    Next i
    
    mae = sumAbsError / n
    mse = sumSqError / n
    rmse = Sqr(mse)
    mape = (sumPctError / n) * 100
    
    Dim accuracy(1 To 4, 1 To 2) As Variant
    accuracy(1, 1) = "MAE": accuracy(1, 2) = mae
    accuracy(2, 1) = "MSE": accuracy(2, 2) = mse
    accuracy(3, 1) = "RMSE": accuracy(3, 2) = rmse
    accuracy(4, 1) = "MAPE": accuracy(4, 2) = mape & "%"
    
    CalculateForecastAccuracy = accuracy
End Function
        </pre>

        <h3 class="section-head">6. Monte Carlo Simulation</h3>

        <h4 class="subsection-head">6.1 Financial Modeling Simulation</h4>
        <pre>
' Monte Carlo simulation for project valuation
Function MonteCarloProjectValuation(baseCase As Variant, _
                                   iterations As Long) As Variant
    
    Dim results() As Double
    ReDim results(1 To iterations, 1 To 4)  ' NPV, IRR, Payback, ROI
    
    ' Define distributions for uncertain variables
    Dim revenueGrowthMean As Double: revenueGrowthMean = 0.05
    Dim revenueGrowthStdDev As Double: revenueGrowthStdDev = 0.02
    
    Dim costMarginMean As Double: costMarginMean = 0.60
    Dim costMarginStdDev As Double: costMarginStdDev = 0.05
    
    Dim waccMean As Double: waccMean = 0.10
    Dim waccStdDev As Double: waccStdDev = 0.015
    
    ' Run simulations
    For i = 1 To iterations
        ' Generate random inputs
        Dim revGrowth As Double
        revGrowth = Application.NormInv(Rnd(), revenueGrowthMean, revenueGrowthStdDev)
        
        Dim costMargin As Double
        costMargin = Application.NormInv(Rnd(), costMarginMean, costMarginStdDev)
        
        Dim wacc As Double
        wacc = Application.NormInv(Rnd(), waccMean, waccStdDev)
        
        ' Calculate project metrics
        results(i, 1) = CalculateNPV(revGrowth, costMargin, wacc)
        results(i, 2) = CalculateIRR(revGrowth, costMargin)
        results(i, 3) = CalculatePaybackPeriod(revGrowth, costMargin)
        results(i, 4) = CalculateROI(revGrowth, costMargin)
    Next i
    
    ' Analyze results
    Dim analysis(1 To 8, 1 To 2) As Variant
    
    analysis(1, 1) = "Mean NPV": analysis(1, 2) = Application.Average( _
        Application.Index(results, 0, 1))
    
    analysis(2, 1) = "Std Dev NPV": analysis(2, 2) = Application.StDev( _
        Application.Index(results, 0, 1))
    
    analysis(3, 1) = "Probability NPV > 0": analysis(3, 2) = Application.CountIf( _
        Application.Index(results, 0, 1), ">0") / iterations
    
    analysis(4, 1) = "Value at Risk (5%)": analysis(4, 2) = Application.Percentile( _
        Application.Index(results, 0, 1), 0.05)
    
    analysis(5, 1) = "Expected Shortfall (5%)": analysis(5, 2) = CalculateExpectedShortfall( _
        Application.Index(results, 0, 1), 0.05)
    
    analysis(6, 1) = "Confidence Interval (95%)": 
    analysis(6, 2) = "[" & Application.Percentile(Application.Index(results, 0, 1), 0.025) & _
                     ", " & Application.Percentile(Application.Index(results, 0, 1), 0.975) & "]"
    
    analysis(7, 1) = "Skewness": analysis(7, 2) = Application.Skew( _
        Application.Index(results, 0, 1))
    
    analysis(8, 1) = "Kurtosis": analysis(8, 2) = Application.Kurt( _
        Application.Index(results, 0, 1))
    
    MonteCarloProjectValuation = Array(results, analysis)
    
    ' Create simulation charts
    CreateMonteCarloCharts results, analysis
End Function

' Sensitivity analysis using tornado charts
Function SensitivityAnalysis(baseCase As Variant, _
                            variables() As String, _
                            ranges() As Variant) As Variant
    
    Dim numVars As Long: numVars = UBound(variables)
    Dim results() As Double
    ReDim results(1 To numVars, 1 To 3)  ' Variable, Low impact, High impact
    
    For i = 1 To numVars
        ' Low case
        Dim lowCase As Variant
        lowCase = baseCase
        lowCase(i) = ranges(i, 1)  ' Low value
        
        Dim lowNPV As Double
        lowNPV = CalculateNPVFromCase(lowCase)
        
        ' High case
        Dim highCase As Variant
        highCase = baseCase
        highCase(i) = ranges(i, 2)  ' High value
        
        Dim highNPV As Double
        highNPV = CalculateNPVFromCase(highCase)
        
        ' Base NPV
        Dim baseNPV As Double
        baseNPV = CalculateNPVFromCase(baseCase)
        
        results(i, 1) = variables(i)
        results(i, 2) = lowNPV - baseNPV
        results(i, 3) = highNPV - baseNPV
    Next i
    
    ' Sort by impact
    SortByImpact results
    
    SensitivityAnalysis = results
    
    ' Create tornado chart
    CreateTornadoChart results, baseNPV
End Function
        </pre>

        <h3 class="section-head">7. Machine Learning Techniques</h3>

        <h4 class="subsection-head">7.1 Clustering with K-Means</h4>
        <pre>
' K-means clustering implementation
Function KMeansClustering(data As Range, _
                         k As Long, _
                         maxIterations As Long, _
                         tolerance As Double) As Variant
    
    Dim n As Long: n = data.Rows.Count
    Dim d As Long: d = data.Columns.Count
    
    ' Initialize centroids randomly
    Dim centroids() As Double
    ReDim centroids(1 To k, 1 To d)
    
    Dim i As Long, j As Long, cluster As Long
    
    For cluster = 1 To k
        Dim randomRow As Long
        randomRow = Application.RandBetween(1, n)
        
        For j = 1 To d
            centroids(cluster, j) = data.Cells(randomRow, j).Value
        Next j
    Next cluster
    
    ' Initialize assignments and distances
    Dim assignments() As Long
    ReDim assignments(1 To n)
    
    Dim distances() As Double
    ReDim distances(1 To n)
    
    Dim oldAssignments() As Long
    Dim iteration As Long
    Dim changed As Boolean
    
    ' Main algorithm
    For iteration = 1 To maxIterations
        ' Assign points to nearest centroid
        changed = False
        
        For i = 1 To n
            Dim minDistance As Double: minDistance = 1E+30
            Dim bestCluster As Long
            
            For cluster = 1 To k
                Dim distance As Double: distance = 0
                
                For j = 1 To d
                    distance = distance + (data.Cells(i, j).Value - _
                              centroids(cluster, j)) ^ 2
                Next j
                
                distance = Sqr(distance)
                
                If distance < minDistance Then
                    minDistance = distance
                    bestCluster = cluster
                End If
            Next cluster
            
            If assignments(i) <> bestCluster Then
                assignments(i) = bestCluster
                changed = True
            End If
            
            distances(i) = minDistance
        Next i
        
        ' Check convergence
        If Not changed Then
            Exit For
        End If
        
        ' Update centroids
        For cluster = 1 To k
            Dim count As Long: count = 0
            Dim sum() As Double
            ReDim sum(1 To d)
            
            For i = 1 To n
                If assignments(i) = cluster Then
                    count = count + 1
                    For j = 1 To d
                        sum(j) = sum(j) + data.Cells(i, j).Value
                    Next j
                End If
            Next i
            
            If count > 0 Then
                For j = 1 To d
                    centroids(cluster, j) = sum(j) / count
                Next j
            End If
        Next cluster
        
        ' Check tolerance
        If iteration > 1 Then
            Dim centroidMovement As Double: centroidMovement = 0
            
            For cluster = 1 To k
                For j = 1 To d
                    centroidMovement = centroidMovement + _
                        (centroids(cluster, j) - oldCentroids(cluster, j)) ^ 2
                Next j
            Next cluster
            
            centroidMovement = Sqr(centroidMovement)
            
            If centroidMovement < tolerance Then
                Exit For
            End If
        End If
        
        ' Save old centroids for comparison
        oldCentroids = centroids
    Next iteration
    
    ' Calculate cluster statistics
    Dim clusterStats() As Variant
    ReDim clusterStats(1 To k, 1 To 4)  ' Size, Within SS, Diameter, Separation
    
    For cluster = 1 To k
        Dim clusterSize As Long: clusterSize = 0
        Dim withinSS As Double: withinSS = 0
        
        For i = 1 To n
            If assignments(i) = cluster Then
                clusterSize = clusterSize + 1
                withinSS = withinSS + distances(i) ^ 2
            End If
        Next i
        
        clusterStats(cluster, 1) = clusterSize
        clusterStats(cluster, 2) = withinSS
        
        ' Calculate cluster diameter (max distance between points)
        clusterStats(cluster, 3) = CalculateClusterDiameter(data, assignments, cluster)
        
        ' Calculate separation from other clusters
        clusterStats(cluster, 4) = CalculateClusterSeparation(centroids, cluster)
    Next cluster
    
    ' Total within-cluster sum of squares
    Dim totalWithinSS As Double: totalWithinSS = 0
    For cluster = 1 To k
        totalWithinSS = totalWithinSS + clusterStats(cluster, 2)
    Next cluster
    
    ' Between-cluster sum of squares
    Dim overallMean() As Double
    ReDim overallMean(1 To d)
    
    For j = 1 To d
        overallMean(j) = Application.Average(data.Columns(j))
    Next j
    
    Dim betweenSS As Double: betweenSS = 0
    For cluster = 1 To k
        Dim clusterMean() As Double
        ReDim clusterMean(1 To d)
        
        For j = 1 To d
            clusterMean(j) = centroids(cluster, j)
        Next j
        
        Dim distanceToOverall As Double: distanceToOverall = 0
        For j = 1 To d
            distanceToOverall = distanceToOverall + _
                (clusterMean(j) - overallMean(j)) ^ 2
        Next j
        
        betweenSS = betweenSS + clusterStats(cluster, 1) * distanceToOverall
    Next cluster
    
    ' Total sum of squares
    Dim totalSS As Double: totalSS = totalWithinSS + betweenSS
    
    ' R-squared (variance explained)
    Dim rSquared As Double: rSquared = betweenSS / totalSS
    
    ' Silhouette score
    Dim silhouetteScore As Double
    silhouetteScore = CalculateSilhouetteScore(data, assignments, distances)
    
    KMeansClustering = Array(assignments, centroids, clusterStats, _
                            totalWithinSS, betweenSS, totalSS, _
                            rSquared, silhouetteScore)
    
    ' Determine optimal k using elbow method
    FindOptimalK data, 10, maxIterations, tolerance
End Function
        </pre>

        <h3 class="section-head">8. Statistical Process Control</h3>

        <h4 class="subsection-head">8.1 Control Charts & Process Capability</h4>
        <pre>
' Statistical process control implementation
Function CreateControlChart(data As Range, _
                           subgroupSize As Long, _
                           chartType As String) As Variant
    
    Dim n As Long: n = data.Rows.Count
    Dim numSubgroups As Long: numSubgroups = n \ subgroupSize
    
    Dim subgroups() As Variant
    ReDim subgroups(1 To numSubgroups, 1 To 4)  ' Mean, Range, UCL, LCL
    
    ' Calculate subgroup statistics
    For i = 1 To numSubgroups
        Dim subgroupRange As Range
        Set subgroupRange = data.Cells((i - 1) * subgroupSize + 1, 1). _
                           Resize(subgroupSize, 1)
        
        subgroups(i, 1) = Application.Average(subgroupRange)  ' Mean
        subgroups(i, 2) = Application.Max(subgroupRange) - _
                         Application.Min(subgroupRange)  ' Range
    Next i
    
    ' Calculate control limits
    Dim overallMean As Double: overallMean = Application.Average(data)
    Dim avgRange As Double: avgRange = Application.Average( _
        Application.Index(subgroups, 0, 2))
    
    ' Constants for control charts (based on subgroup size)
    Dim A2 As Double, D3 As Double, D4 As Double
    
    Select Case subgroupSize
        Case 2: A2 = 1.880: D3 = 0: D4 = 3.267
        Case 3: A2 = 1.023: D3 = 0: D4 = 2.574
        Case 4: A2 = 0.729: D3 = 0: D4 = 2.282
        Case 5: A2 = 0.577: D3 = 0: D4 = 2.114
        Case 6: A2 = 0.483: D3 = 0: D4 = 2.004
        Case 7: A2 = 0.419: D3 = 0.076: D4 = 1.924
        Case 8: A2 = 0.373: D3 = 0.136: D4 = 1.864
        Case 9: A2 = 0.337: D3 = 0.184: D4 = 1.816
        Case 10: A2 = 0.308: D3 = 0.223: D4 = 1.777
    End Select
    
    ' Set control limits
    For i = 1 To numSubgroups
        Select Case UCase(chartType)
            Case "X-BAR"
                subgroups(i, 3) = overallMean + A2 * avgRange  ' UCL
                subgroups(i, 4) = overallMean - A2 * avgRange  ' LCL
                
            Case "R"
                subgroups(i, 3) = D4 * avgRange  ' UCL
                subgroups(i, 4) = D3 * avgRange  ' LCL
                
            Case "P"  ' For proportions
                ' Different calculation
                Dim pBar As Double: pBar = Application.Average(data)
                Dim n_i As Double: n_i = subgroupSize
                
                subgroups(i, 3) = pBar + 3 * Sqr(pBar * (1 - pBar) / n_i)
                subgroups(i, 4) = pBar - 3 * Sqr(pBar * (1 - pBar) / n_i)
        End Select
    Next i
    
    ' Check for out-of-control points
    Dim outOfControl() As Long
    Dim count As Long: count = 0
    
    For i = 1 To numSubgroups
        Select Case UCase(chartType)
            Case "X-BAR"
                If subgroups(i, 1) > subgroups(i, 3) Or _
                   subgroups(i, 1) < subgroups(i, 4) Then
                    count = count + 1
                    ReDim Preserve outOfControl(1 To count)
                    outOfControl(count) = i
                End If
        End Select
    Next i
    
    ' Process capability indices
    Dim cp As Double, cpk As Double, pp As Double, ppk As Double
    Dim usl As Double, lsl As Double
    
    ' Assuming specifications are provided
    usl = 100  ' Upper specification limit
    lsl = 90   ' Lower specification limit
    
    Dim stdDevWithin As Double: stdDevWithin = avgRange / GetD2(subgroupSize)
    Dim stdDevOverall As Double: stdDevOverall = Application.StDev(data)
    
    cp = (usl - lsl) / (6 * stdDevWithin)
    cpk = Application.Min((usl - overallMean) / (3 * stdDevWithin), _
                         (overallMean - lsl) / (3 * stdDevWithin))
    
    pp = (usl - lsl) / (6 * stdDevOverall)
    ppk = Application.Min((usl - overallMean) / (3 * stdDevOverall), _
                         (overallMean - lsl) / (3 * stdDevOverall))
    
    CreateControlChart = Array(subgroups, outOfControl, _
                              Array(cp, cpk, pp, ppk), _
                              overallMean, avgRange, stdDevWithin, stdDevOverall)
    
    ' Create control chart visualization
    CreateSPCChart subgroups, chartType, outOfControl
End Function
        </pre>

        <h3 class="section-head">9. Advanced Statistical Functions</h3>

        <h4 class="subsection-head">9.1 Custom Statistical Calculations</h4>
        <pre>
' Bayesian statistics functions
Function BayesianUpdate(priorMean As Double, priorVariance As Double, _
                       dataMean As Double, dataVariance As Double, _
                       sampleSize As Long) As Variant
    
    ' Bayesian updating for normal distribution
    Dim posteriorMean As Double
    Dim posteriorVariance As Double
    
    posteriorVariance = 1 / (1 / priorVariance + sampleSize / dataVariance)
    posteriorMean = posteriorVariance * (priorMean / priorVariance + _
                    sampleSize * dataMean / dataVariance)
    
    ' Credible interval (95%)
    Dim lowerBound As Double, upperBound As Double
    lowerBound = posteriorMean - 1.96 * Sqr(posteriorVariance)
    upperBound = posteriorMean + 1.96 * Sqr(posteriorVariance)
    
    BayesianUpdate = Array(posteriorMean, posteriorVariance, _
                          lowerBound, upperBound)
End Function

' Bootstrapping for confidence intervals
Function BootstrapCI(data As Range, _
                    statisticFunc As String, _
                    confidenceLevel As Double, _
                    bootstrapSamples As Long) As Variant
    
    Dim n As Long: n = data.Rows.Count
    Dim bootstrapStats() As Double
    ReDim bootstrapStats(1 To bootstrapSamples)
    
    ' Generate bootstrap samples
    For b = 1 To bootstrapSamples
        Dim sampleData() As Double
        ReDim sampleData(1 To n)
        
        ' Resample with replacement
        For i = 1 To n
            Dim randomIndex As Long
            randomIndex = Application.RandBetween(1, n)
            sampleData(i) = data.Cells(randomIndex, 1).Value
        Next i
        
        ' Calculate statistic
        Select Case UCase(statisticFunc)
            Case "MEAN"
                bootstrapStats(b) = Application.Average(sampleData)
            Case "MEDIAN"
                bootstrapStats(b) = Application.Median(sampleData)
            Case "STDEV"
                bootstrapStats(b) = Application.StDev(sampleData)
            Case "PERCENTILE"
                bootstrapStats(b) = Application.Percentile(sampleData, 0.5)
        End Select
    Next b
    
    ' Calculate confidence interval
    Dim alpha As Double: alpha = 1 - confidenceLevel
    Dim lowerCI As Double: lowerCI = Application.Percentile(bootstrapStats, alpha / 2)
    Dim upperCI As Double: upperCI = Application.Percentile(bootstrapStats, 1 - alpha / 2)
    
    BootstrapCI = Array(lowerCI, upperCI, Application.StDev(bootstrapStats))
    
    ' Plot bootstrap distribution
    PlotBootstrapDistribution bootstrapStats, lowerCI, upperCI
End Function
        </pre>

        <h3 class="section-head">10. Best Practices & Reporting</h3>

        <h4 class="subsection-head">10.1 Statistical Report Creation</h4>
        <ul style="margin-left: 25px;">
            <li>Always state assumptions and limitations</li>
            <li>Report effect sizes, not just p-values</li>
            <li>Include confidence intervals for estimates</li>
            <li>Use appropriate visualizations for different data types</li>
            <li>Document data preparation steps</li>
            <li>Validate models with holdout samples</li>
            <li>Check for multicollinearity in regression</li>
            <li>Test for heteroscedasticity and autocorrelation</li>
            <li>Consider multiple testing corrections</li>
            <li>Provide practical interpretation of results</li>
        </ul>

        <h4 class="subsection-head">10.2 Automated Statistical Reporting</h4>
        <pre>
' Generate comprehensive statistical report
Sub GenerateStatisticalReport(dataSheet As Worksheet, _
                             outputSheet As Worksheet)
    
    ' Clear existing content
    outputSheet.Cells.Clear
    
    ' Report header
    With outputSheet
        .Range("A1").Value = "Statistical Analysis Report"
        .Range("A1").Font.Size = 16
        .Range("A1").Font.Bold = True
        
        .Range("A2").Value = "Generated: " & Now
        .Range("A3").Value = "Data Source: " & dataSheet.Name
    End With
    
    Dim row As Long: row = 5
    
    ' 1. Data Overview
    outputSheet.Cells(row, 1).Value = "1. Data Overview"
    outputSheet.Cells(row, 1).Font.Bold = True
    row = row + 1
    
    Dim dataRange As Range
    Set dataRange = dataSheet.UsedRange
    
    outputSheet.Cells(row, 1).Value = "Total Records:"
    outputSheet.Cells(row, 2).Value = dataRange.Rows.Count - 1  ' Exclude header
    row = row + 1
    
    outputSheet.Cells(row, 1).Value = "Variables:"
    outputSheet.Cells(row, 2).Value = dataRange.Columns.Count
    row = row + 2
    
    ' 2. Descriptive Statistics for each variable
    outputSheet.Cells(row, 1).Value = "2. Descriptive Statistics"
    outputSheet.Cells(row, 1).Font.Bold = True
    row = row + 1
    
    Dim col As Long
    For col = 1 To dataRange.Columns.Count
        Dim varName As String
        varName = dataSheet.Cells(1, col).Value
        
        outputSheet.Cells(row, 1).Value = varName
        outputSheet.Cells(row, 1).Font.Bold = True
        row = row + 1
        
        ' Calculate statistics
        Dim varData As Range
        Set varData = dataSheet.Range(dataSheet.Cells(2, col), _
                                     dataSheet.Cells(dataRange.Rows.Count, col))
        
        Dim stats As Variant
        stats = GetDescriptiveStats(varData)
        
        ' Write statistics
        Dim i As Long
        For i = 1 To UBound(stats, 1)
            outputSheet.Cells(row, 1).Value = stats(i, 1)
            outputSheet.Cells(row, 2).Value = stats(i, 2)
            row = row + 1
        Next i
        
        row = row + 1  ' Add space between variables
    Next col
    
    ' 3. Correlation Matrix
    outputSheet.Cells(row, 1).Value = "3. Correlation Matrix"
    outputSheet.Cells(row, 1).Font.Bold = True
    row = row + 1
    
    CreateCorrelationMatrix dataSheet, outputSheet.Cells(row, 1)
    row = row + dataRange.Columns.Count + 2
    
    ' 4. Statistical Tests
    outputSheet.Cells(row, 1).Value = "4. Statistical Tests"
    outputSheet.Cells(row, 1).Font.Bold = True
    row = row + 1
    
    ' Add specific tests based on data characteristics
    AddStatisticalTests dataSheet, outputSheet, row
    
    ' 5. Recommendations
    outputSheet.Cells(row, 1).Value = "5. Recommendations"
    outputSheet.Cells(row, 1).Font.Bold = True
    row = row + 1
    
    GenerateRecommendations dataSheet, outputSheet, row
    
    ' Format the report
    FormatStatisticalReport outputSheet
End Sub
        </pre>

        <div class="pro-note">
            <b><i class="fas fa-tools"></i> Pro Tip:</b> Excel's statistical capabilities are often underestimated. With proper techniques and understanding of limitations, you can perform 80% of business statistical analysis directly in Excel without specialized software.
        </div>

        <button class="btn-premium" onclick="completeModule()">
            <i class="fas fa-trophy"></i> Take Final Exam & Claim Certificate
        </button>
    `
},
];

const quizData = [
    { 
        q: "In Excel's calculation engine, what is the primary performance drawback of 'Volatile Functions' like OFFSET() or INDIRECT()?", 
        options: ["They only calculate when the file is opened", "They trigger recalculation of the entire workbook every time any change is made", "They disable multi-threaded calculation", "They are only compatible with 32-bit Excel"], 
        correct: 1 
    },
    { 
        q: "When using Excel 365 Dynamic Arrays, what does the '#' symbol signify in a cell reference (e.g., =SUM(A2#))?", 
        options: ["It refers to a hidden comment", "It forces the formula to be an absolute reference", "It references the entire 'Spill Range' starting from that cell", "It flags an error in the calculation chain"], 
        correct: 2 
    },
    { 
        q: "In Power Query, which concept involves pushing data transformation steps back to the source database to improve efficiency?", 
        options: ["Query Merging", "Query Folding", "Data Modeling", "M-Language Compilation"], 
        correct: 1 
    },
    { 
        q: "What is the fundamental difference between a 'Calculated Column' and a 'Measure' in DAX (Power Pivot)?", 
        options: ["Measures are stored in the database, while columns are not", "Calculated Columns increase model size; Measures are calculated on-the-fly based on filter context", "Measures can only be used in Power BI, not Excel", "Calculated Columns are faster for large datasets"], 
        correct: 1 
    },
    { 
        q: "Which Excel function is designed to assign names to calculation results, reducing redundant calculations and improving formula readability?", 
        options: ["LAMBDA", "XLOOKUP", "LET", "SWITCH"], 
        correct: 2 
    },
    { 
        q: "In Financial Modeling, which Excel feature must be enabled to allow a model to resolve a circular reference intentionally?", 
        options: ["Automatic Recalculation", "Multi-threaded Processing", "Iterative Calculation", "Data Validation"], 
        correct: 2 
    },
    { 
        q: "What is the most memory-efficient way to process a large range of data in VBA?", 
        options: ["Looping through each cell using 'For Each Cell In Range'", "Using 'Select' and 'Activate' on every iteration", "Reading the entire Range into a Variant Array and processing it in memory", "Writing results to the sheet one cell at a time"], 
        correct: 2 
    },
    { 
        q: "In a Star Schema data model, what is the primary characteristic of a 'Fact Table'?", 
        options: ["It contains unique descriptive attributes of a business entity", "It contains quantitative metrics and foreign keys to dimension tables", "It is usually the smallest table in the model", "It stores the M-language scripts for Power Query"], 
        correct: 1 
    },
    { 
        q: "When performing Regression Analysis in Excel, which statistic indicates the proportion of the variance for a dependent variable that's explained by an independent variable?", 
        options: ["Standard Error", "F-Statistic", "R-Squared", "P-Value"], 
        correct: 2 
    },
    { 
        q: "In Monte Carlo simulations, why do we use functions like NORM.INV(RAND(), mean, std_dev)?", 
        options: ["To find the exact average of a historical dataset", "To generate a random value based on a specific probability distribution", "To prevent Excel from crashing during high-volume calculations", "To sort data into clusters automatically"], 
        correct: 1 
    }
];

let maxUnlocked = 0;
let currentModule = 0;
let examScore = 0;
let examTaken = false;

function toggleSidebar(){
    document.getElementById('toc').classList.toggle('active');
    document.getElementById('overlay').classList.toggle('active');
}

function startCourse(){
    document.getElementById('welcome-screen').classList.add('hidden');
    document.getElementById('course-player').classList.remove('hidden');
    document.querySelector('.sidebar-toggle').style.display='block';
    loadModule(0); 
    renderTOC();
}

function renderTOC(){
    const toc = document.getElementById('toc');
    let html = `
        <div class="sidebar-header">
            <h3 class="sidebar-title"><i class="fas fa-book-open"></i> COURSE MODULES</h3>
            <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">${syllabus.length} comprehensive modules</div>
        </div>
    `;
    
    syllabus.forEach((mod,i)=>{
        const locked = i > maxUnlocked;
        const completed = i < maxUnlocked;
        const active = i === currentModule;
        
        html += `
        <div class="module-item ${active?'active':''} ${locked?'locked':''}" onclick="${!locked?`loadModule(${i})`:''}">
            <div class="module-number">${i+1}</div>
            <div class="module-text">
                <div class="module-title">${mod.title.replace("Module " + (i+1).toString().padStart(2, '0') + ": ", "")}</div>
                <div class="module-desc">${mod.desc}</div>
            </div>
            <div class="module-status">
                ${locked ? 
                    '<i class="fas fa-lock" style="color: #94a3b8;"></i>' : 
                    completed ? 
                    '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : 
                    '<i class="fas fa-play-circle" style="color: var(--primary);"></i>'
                }
            </div>
        </div>`;
    });
    
    html += `
        <div style="padding: 25px; text-align: center; margin-top: 20px; border-top: 1px solid var(--border-dark);">
            <div style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 10px;">Progress</div>
            <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: ${Math.round((maxUnlocked/(syllabus.length-1))*100)}%; background: var(--primary); border-radius: 3px;"></div>
            </div>
            <div style="color: white; font-size: 0.9rem; margin-top: 10px; font-weight: 600;">
                ${maxUnlocked}/${syllabus.length} modules completed
            </div>
        </div>
    `;
    
    toc.innerHTML = html;
}

function loadModule(idx){
    currentModule = idx;
    document.getElementById('loader').classList.add('active');
    
    setTimeout(() => {
        document.getElementById('module-content').classList.remove('hidden');
        document.getElementById('exam-section').classList.add('hidden');
        document.getElementById('final-step-section').classList.add('hidden');
        document.getElementById('module-content').innerHTML = syllabus[idx].content;
        
        const prog = Math.round((maxUnlocked/(syllabus.length-1))*100);
        document.getElementById('progress-fill').style.width = prog + "%";
        document.getElementById('prog-stat-text').innerText = prog + "% COMPLETE";
        
        renderTOC(); 
        window.scrollTo(0,0);
        document.getElementById('loader').classList.remove('active');
    }, 300);
}

function completeModule(){
    if(currentModule === syllabus.length-1){
        showExam();
    } else {
        if(currentModule === maxUnlocked) {
            maxUnlocked++;
            Swal.fire({
                title: "Module Completed!",
                text: `You've unlocked Module ${currentModule+2}`,
                icon: "success",
                confirmButtonText: "Continue",
                confirmButtonColor: "var(--primary)"
            });
        }
        loadModule(currentModule+1);
    }
}

function showExam(){
    document.getElementById('module-content').classList.add('hidden');
    const examBox = document.getElementById('exam-section');
    examBox.classList.remove('hidden');

    let html = `
        <span class="module-tag"><i class="fas fa-graduation-cap"></i> FINAL ASSESSMENT</span>
        <h2 class="mod-title">Proctored Final Exam</h2>
        <p class="body-text">Complete this final assessment to earn your Elite Excel Mastery certificate. Score 50% or above to pass.</p>
        
        <div style="background: #f0f9ff; padding: 20px; border-radius: 16px; margin-bottom: 30px; border-left: 4px solid var(--primary);">
            <h4 style="font-weight: 700; margin-bottom: 10px; color: var(--dark-bg);"><i class="fas fa-info-circle"></i> Exam Details</h4>
            <p style="color: #475569; margin-bottom: 5px;"><b>Questions:</b> ${quizData.length} multiple choice</p>
            <p style="color: #475569; margin-bottom: 5px;"><b>Passing Score:</b> 50% or higher</p>
            <p style="color: #475569;"><b>Time:</b> No time limit</p>
        </div>
    `;
    
    quizData.forEach((item,i)=>{
        html += `<div class="q-block">
            <p style="font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; color: var(--dark-bg);">
                <span style="background: var(--primary); color: white; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.9rem; margin-right: 10px;">${i+1}</span>
                ${item.q}
            </p>`;
        item.options.forEach((opt,oi)=>{
            html += `
            <label class="option-label">
                <input type="radio" name="q_${i}" value="${oi}">
                ${opt}
            </label>`;
        });
        html += `</div>`;
    });
    
    html += `<button class="btn-primary" onclick="submitExam()">
        <i class="fas fa-paper-plane"></i> Submit Exam
    </button>`;
    
    examBox.innerHTML = html;
    window.scrollTo(0,0);
}

function submitExam(){
    let score = 0;
    const results = [];
    
    quizData.forEach((item,i)=>{
        const ans = document.querySelector(`input[name="q_${i}"]:checked`);
        if(ans && parseInt(ans.value) === item.correct){
            score++;
            results.push({question: i, correct: true});
        } else {
            results.push({question: i, correct: false, selected: ans ? parseInt(ans.value) : null});
        }
    });

    examScore = score;
    const percent = Math.round((score/quizData.length)*100);
    examTaken = true;

    // Create detailed results HTML
    let resultsHTML = `
        <div class="score-display">
            <h3 style="margin-bottom: 10px; font-weight: 700;">Exam Results</h3>
            <div class="score-value">${percent}%</div>
            <p style="font-size: 1.1rem; margin-bottom: 20px;">${score}/${quizData.length} Correct Answers</p>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-top: 15px;">
                <p style="margin-bottom: 8px;"><b>Status:</b> <span style="color: ${percent >= 50 ? '#4ade80' : '#f87171'}">${percent >= 50 ? 'PASSED' : 'FAILED'}</span></p>
                <p><b>Required to pass:</b> 50%</p>
            </div>
        </div>
        
        <h3 style="margin: 30px 0 15px; color: var(--dark-bg);">Question Review</h3>
    `;
    
    results.forEach((result, i) => {
        resultsHTML += `
        <div style="background: ${result.correct ? '#f0fdf4' : '#fef2f2'}; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${result.correct ? '#10b981' : '#ef4444'};">
            <p style="font-weight: 600; margin-bottom: 8px; color: var(--dark-bg);">${i+1}. ${quizData[i].q}</p>
            <p style="margin-bottom: 5px;"><b>Your answer:</b> ${result.selected !== null ? quizData[i].options[result.selected] : 'Not answered'}</p>
            <p><b>Correct answer:</b> ${quizData[i].options[quizData[i].correct]}</p>
        </div>`;
    });

    if(percent >= 50){
        Swal.fire({
            title: "Congratulations!",
            html: `<div style="text-align: left;">${resultsHTML}</div>`,
            icon: "success",
            confirmButtonText: "Claim Certificate",
            confirmButtonColor: "var(--primary)",
            width: 800
        }).then(()=>{
            document.getElementById('exam-section').classList.add('hidden');
            document.getElementById('final-step-section').classList.remove('hidden');
        });
    } else {
        Swal.fire({
            title: "Try Again",
            html: `<div style="text-align: left;">${resultsHTML}</div>`,
            icon: "error",
            confirmButtonText: "Retry Exam",
            confirmButtonColor: "var(--primary)",
            width: 800
        }).then(() => {
            // Allow retaking the exam
            showExam();
        });
    }
}

function claimCertificate(){
    const name = document.getElementById('student-name').value.trim();
    const course = "Elite Excel Mastery"; // The proper course name

    if(!name) {
        return Swal.fire("Error","Please enter your full name.","error");
    }
    
    // Save to localStorage as backup
    localStorage.setItem("internadda_cert_name", name);
    localStorage.setItem("internadda_course_name", course);
    
    Swal.fire({
        title: "Generating Certificate...",
        text: "Redirecting you to your official certificate.",
        icon: "success",
        timer: 2000,
        showConfirmButton: false
    }).then(() => {
        // Construct the URL with encoded parameters for safety
        const urlName = encodeURIComponent(name);
        const urlCourse = encodeURIComponent(course);
        
        // Redirect to certificate.html with parameters
        window.location.href = `certificate.html?name=${urlName}&course=${urlCourse}`;
    });
}

</script>
</body>
</html>
